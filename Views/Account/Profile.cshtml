@model ASM1_NET.Models.User
@{
    ViewData["Title"] = "H·ªì s∆° c√° nh√¢n";
}

<link rel="stylesheet" href="~/client/css/fastfood-theme.css" />
<link rel="stylesheet" href="~/client/css/profile.css" />

<div class="profile-page">
    <div class="profile-wrapper">
        <!-- Hero -->
        <div class="profile-hero">
            <h1>üë§ H·ªì s∆° c√° nh√¢n</h1>
            <p>Qu·∫£n l√Ω th√¥ng tin t√†i kho·∫£n c·ªßa b·∫°n</p>
        </div>
        
        <div class="profile-container">
            <!-- Left: Avatar & Info -->
            <div class="profile-sidebar">
                <div class="profile-avatar-section">
                    <form id="avatarForm" action="/Account/UpdateAvatar" method="post" enctype="multipart/form-data">
                        @Html.AntiForgeryToken()
                        <input type="file" id="avatarInput" name="avatar" accept="image/*" style="display: none;" 
                               onchange="document.getElementById('avatarForm').submit();" />
                        
                        <div class="profile-avatar-wrapper">
                            @if (!string.IsNullOrEmpty(Model.AvatarUrl))
                            {
                                <img src="@Model.AvatarUrl" alt="Avatar" class="profile-avatar-img" 
                                     onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';" />
                                <div class="profile-avatar-placeholder" style="display: none;">
                                    @Model.FullName.Substring(0, 1).ToUpper()
                                </div>
                            }
                            else
                            {
                                <div class="profile-avatar-placeholder">
                                    @Model.FullName.Substring(0, 1).ToUpper()
                                </div>
                            }
                            
                            <div class="profile-avatar-edit" onclick="document.getElementById('avatarInput').click();" title="ƒê·ªïi ·∫£nh ƒë·∫°i di·ªán">
                                üì∑
                            </div>
                        </div>
                    </form>
                    
                    <div class="profile-name">@Model.FullName</div>
                    <div class="profile-email">@Model.Email</div>
                    <div class="profile-badge @Model.Role.ToLower()">
                        @switch(Model.Role) {
                            case "Admin": <text>üëë Qu·∫£n tr·ªã vi√™n</text> break;
                            case "Staff": <text>üë®‚Äçüíº Nh√¢n vi√™n</text> break;
                            case "Shipper": <text>üöö Shipper</text> break;
                            default: <text>üõí Kh√°ch h√†ng</text> break;
                        }
                    </div>
                    
                    @if (Model.EmailVerified)
                    {
                        <div class="verified-badge">‚úÖ Email ƒë√£ x√°c th·ª±c</div>
                    }
                    
                    <!-- Loyalty Points Badge -->
                    <div class="loyalty-points-badge">
                        <span class="points-icon">‚≠ê</span>
                        <span class="points-value">@Model.TotalPoints</span>
                        <span class="points-label">ƒëi·ªÉm t√≠ch l≈©y</span>
                    </div>
                </div>
                
                <!-- Quick Links -->
                <div class="profile-quick-links">
                    <a href="/" class="quick-link"><span>üè†</span> Trang ch·ªß</a>
                    <a href="/Order/History" class="quick-link"><span>üì¶</span> L·ªãch s·ª≠ ƒë∆°n h√†ng</a>
                    <a href="/Cart" class="quick-link"><span>üõí</span> Gi·ªè h√†ng</a>
                    <a href="/Account/Logout" class="quick-link logout"><span>üö™</span> ƒêƒÉng xu·∫•t</a>
                </div>
            </div>
            
            <!-- Right: Forms -->
            <div class="profile-content">
                @if (TempData["Success"] != null)
                {
                    <div class="profile-alert success">‚úÖ @TempData["Success"]</div>
                }
                @if (TempData["Error"] != null)
                {
                    <div class="profile-alert error">‚ö†Ô∏è @TempData["Error"]</div>
                }
                
                <!-- Update Info Form -->
                <div class="profile-card">
                    <h3>üìù Th√¥ng tin c√° nh√¢n</h3>
                    <form method="post" action="/Account/Profile">
                        @Html.AntiForgeryToken()
                        
                        <div class="form-row">
                            <div class="profile-form-group">
                                <label>üë§ H·ªç v√† t√™n</label>
                                <input type="text" name="FullName" value="@Model.FullName" required />
                            </div>
                            <div class="profile-form-group">
                                <label>üì± S·ªë ƒëi·ªán tho·∫°i</label>
                                <input type="tel" name="Phone" value="@Model.Phone" placeholder="Nh·∫≠p s·ªë ƒëi·ªán tho·∫°i" />
                            </div>
                        </div>
                        
                        <div class="profile-form-group">
                            <label>üìß Email</label>
                            <input type="email" value="@Model.Email" disabled class="disabled-input" />
                            <span class="form-hint">Email kh√¥ng th·ªÉ thay ƒë·ªïi</span>
                        </div>
                        
                        <div class="profile-form-group">
                            <label>üìç ƒê·ªãa ch·ªâ giao h√†ng</label>
                            @{
                                var savedAddresses = ViewBag.SavedAddresses as List<ASM1_NET.Models.UserAddress>;
                            }
                            @if (savedAddresses != null && savedAddresses.Count > 0)
                            {
                                <select id="addressDropdown" class="profile-select" 
                                        onchange="fillAddressFromDropdown(this)" style="margin-bottom: 10px;">
                                    <option value="">-- Ch·ªçn ƒë·ªãa ch·ªâ ƒë√£ l∆∞u --</option>
                                    @foreach (var addr in savedAddresses)
                                    {
                                        var selected = addr.FullAddress == Model.Address ? "selected" : "";
                                        if (addr.FullAddress == Model.Address)
                                        {
                                            <option value="@addr.FullAddress" selected>@addr.Name - @addr.FullAddress</option>
                                        }
                                        else
                                        {
                                            <option value="@addr.FullAddress">@addr.Name - @addr.FullAddress</option>
                                        }
                                    }
                                </select>
                            }
                            <input type="text" name="Address" id="addressInput" value="@Model.Address" 
                                   placeholder="Nh·∫≠p ƒë·ªãa ch·ªâ giao h√†ng ho·∫∑c ch·ªçn t·ª´ danh s√°ch" />
                            <div style="display: flex; justify-content: flex-end; margin-top: 8px;">
                                <a href="/Address" style="color: #22c55e; font-size: 0.9rem;">‚öôÔ∏è Qu·∫£n l√Ω ƒë·ªãa ch·ªâ</a>
                            </div>
                        </div>
                        
                        <button type="submit" class="btn-save">üíæ L∆∞u thay ƒë·ªïi</button>
                    </form>
                </div>
                
                <!-- Change Password Form -->
                <div class="profile-card">
                    <h3>üîí ƒê·ªïi m·∫≠t kh·∫©u</h3>
                    <p class="card-desc">ƒê·ªÉ b·∫£o m·∫≠t, b·∫°n c·∫ßn x√°c th·ª±c qua email khi ƒë·ªïi m·∫≠t kh·∫©u</p>
                    
                    <form method="post" action="/Account/RequestPasswordChange" id="passwordForm">
                        @Html.AntiForgeryToken()
                        
                        <div class="profile-form-group">
                            <label>üîë M·∫≠t kh·∫©u m·ªõi</label>
                            <input type="password" name="newPassword" id="newPassword" minlength="6" 
                                   placeholder="Nh·∫≠p m·∫≠t kh·∫©u m·ªõi (√≠t nh·∫•t 6 k√Ω t·ª±)" required />
                        </div>
                        
                        <div class="profile-form-group">
                            <label>üîë X√°c nh·∫≠n m·∫≠t kh·∫©u</label>
                            <input type="password" id="confirmPassword" 
                                   placeholder="Nh·∫≠p l·∫°i m·∫≠t kh·∫©u m·ªõi" required />
                        </div>
                        
                        <button type="submit" class="btn-change-password">üìß G·ª≠i m√£ x√°c th·ª±c</button>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- OTP Modal -->
<div id="otpModal" class="modal-overlay" style="display: @(TempData["ShowOTPModal"] != null ? "flex" : "none");">
    <div class="modal-content">
        <h3>üîê Nh·∫≠p m√£ x√°c th·ª±c</h3>
        <p>Vui l√≤ng nh·∫≠p m√£ 6 s·ªë ƒë√£ g·ª≠i ƒë·∫øn email c·ªßa b·∫°n</p>
        
        <form method="post" action="/Account/ConfirmPasswordChange">
            @Html.AntiForgeryToken()
            
            <div class="otp-input-container">
                <input type="text" name="otp" id="otpInput" maxlength="6" pattern="[0-9]{6}" 
                       placeholder="______" required autofocus />
            </div>
            
            <div class="modal-buttons">
                <button type="submit" class="btn-confirm">‚úÖ X√°c nh·∫≠n</button>
                <button type="button" class="btn-cancel" onclick="closeOTPModal()">‚ùå H·ªßy</button>
            </div>
        </form>
    </div>
</div>

<script src="~/client/js/profile-page.js"></script>