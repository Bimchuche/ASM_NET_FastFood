@model IEnumerable<ASM1_NET.Models.Combo>
@{
    ViewData["Title"] = "Combo";
    var keyword = ViewBag.Keyword as string ?? "";
    var sortBy = ViewBag.SortBy as string ?? "";
    var minPrice = ViewBag.MinPrice as decimal?;
    var maxPrice = ViewBag.MaxPrice as decimal?;
    var minRating = ViewBag.MinRating as int?;
    var comboRatings = ViewBag.ComboRatings as Dictionary<int, dynamic> ?? new Dictionary<int, dynamic>();
    var currentPage = (int)(ViewBag.CurrentPage ?? 1);
    var totalPages = (int)(ViewBag.TotalPages ?? 1);
    var totalItems = (int)(ViewBag.TotalItems ?? 0);
}

<link rel="stylesheet" href="~/client/css/menu.css" />
<link rel="stylesheet" href="~/client/css/modal.css" />
<link rel="stylesheet" href="~/client/css/combo-search.css" />

<div class="combo-page menu-page">
    <div class="container">
        <!-- HERO BANNER -->
        <div class="combo-hero menu-hero animate-fade-in">
            <div class="menu-hero-content">
                <h1>üéÅ Combo ti·∫øt ki·ªám</h1>
                <p>Ti·∫øt ki·ªám h∆°n khi mua combo - Gi√° h·ªùi, ch·∫•t l∆∞·ª£ng!</p>
            </div>
        </div>

        <!-- ADVANCED SEARCH BAR -->
        <div class="advanced-search-container animate-slide-up">
            <form method="get" asp-action="Index" class="advanced-search-form" id="searchForm">
                <!-- Row 1: Keyword search -->
                <div class="search-row">
                    <div class="search-input-wrapper">
                        <span class="search-icon">üîç</span>
                        <input type="text" name="keyword" placeholder="T√¨m combo y√™u th√≠ch..." value="@keyword" />
                        @if (!string.IsNullOrEmpty(keyword))
                        {
                            <a href="/Combo" class="clear-search">‚úï</a>
                        }
                    </div>
                    <button type="submit" class="search-btn">T√¨m ki·∫øm</button>
                </div>
                
                <!-- Row 2: Filters -->
                <div class="filter-row">
                    <div class="filter-group">
                        <label>üí∞ Gi√° t·ª´</label>
                        <input type="number" name="minPrice" placeholder="VD: 50000" value="@minPrice" class="filter-input" />
                    </div>
                    <div class="filter-group">
                        <label>üí∞ ƒê·∫øn</label>
                        <input type="number" name="maxPrice" placeholder="VD: 200000" value="@maxPrice" class="filter-input" />
                    </div>
                    <div class="filter-group">
                        <label>‚≠ê ƒê√°nh gi√° t·ªëi thi·ªÉu</label>
                        <select name="minRating" class="filter-select">
                            <option value="">T·∫•t c·∫£</option>
                            <option value="5" selected="@(minRating == 5)">‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê 5 sao</option>
                            <option value="4" selected="@(minRating == 4)">‚≠ê‚≠ê‚≠ê‚≠ê 4+ sao</option>
                            <option value="3" selected="@(minRating == 3)">‚≠ê‚≠ê‚≠ê 3+ sao</option>
                            <option value="2" selected="@(minRating == 2)">‚≠ê‚≠ê 2+ sao</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label>üìä S·∫Øp x·∫øp theo</label>
                        <select name="sortBy" class="filter-select">
                            <option value="" selected="@(string.IsNullOrEmpty(sortBy))">M·ªõi nh·∫•t</option>
                            <option value="price_asc" selected="@(sortBy == "price_asc")">Gi√°: Th·∫•p ‚Üí Cao</option>
                            <option value="price_desc" selected="@(sortBy == "price_desc")">Gi√°: Cao ‚Üí Th·∫•p</option>
                            <option value="name_asc" selected="@(sortBy == "name_asc")">T√™n: A ‚Üí Z</option>
                            <option value="name_desc" selected="@(sortBy == "name_desc")">T√™n: Z ‚Üí A</option>
                            <option value="rating" selected="@(sortBy == "rating")">ƒê√°nh gi√° cao nh·∫•t</option>
                        </select>
                    </div>
                </div>
                
                <!-- Active filters -->
                @if (!string.IsNullOrEmpty(keyword) || minPrice.HasValue || maxPrice.HasValue || minRating.HasValue || !string.IsNullOrEmpty(sortBy))
                {
                    <div class="active-filters">
                        <span class="filter-label">üè∑Ô∏è B·ªô l·ªçc ƒëang √°p d·ª•ng:</span>
                        @if (!string.IsNullOrEmpty(keyword))
                        {
                            <span class="filter-tag">üîç "@keyword"</span>
                        }
                        @if (minPrice.HasValue)
                        {
                            <span class="filter-tag">üí∞ T·ª´ @minPrice.Value.ToString("N0")ƒë</span>
                        }
                        @if (maxPrice.HasValue)
                        {
                            <span class="filter-tag">üí∞ ƒê·∫øn @maxPrice.Value.ToString("N0")ƒë</span>
                        }
                        @if (minRating.HasValue)
                        {
                            <span class="filter-tag">‚≠ê @minRating+ sao</span>
                        }
                        <a href="/Combo" class="clear-all-filters">‚úï X√≥a t·∫•t c·∫£</a>
                    </div>
                }
            </form>
        </div>

        <!-- SEARCH RESULT INFO -->
        <div class="d-flex justify-content-center mb-4">
            <div class="search-result-info">
                Hi·ªÉn th·ªã <strong>@Model.Count()</strong> / <strong>@totalItems</strong> combo
            </div>
        </div>

        <!-- COMBO GRID -->
        <div class="menu-grid">
            @if (!Model.Any())
            {
                <div style="grid-column: 1 / -1;">
                    <div class="menu-empty-state animate-fade-in">
                        <div class="empty-icon">üîç</div>
                        <h3>Kh√¥ng t√¨m th·∫•y combo n√†o</h3>
                        <p>H√£y th·ª≠ t√¨m ki·∫øm v·ªõi t·ª´ kh√≥a kh√°c ho·∫∑c ƒëi·ªÅu ch·ªânh b·ªô l·ªçc</p>
                        <a href="/Combo" class="btn btn-primary btn-lg rounded-pill px-4" style="background: #6c5ce7; border: none;">Xem t·∫•t c·∫£ combo</a>
                    </div>
                </div>
            }
            else
            {
                var delay = 0.0;
                @foreach (var combo in Model)
                {
                    var hasRating = comboRatings.ContainsKey(combo.Id);
                    var avgRating = hasRating ? (double)comboRatings[combo.Id].AvgRating : 0;
                    var reviewCount = hasRating ? (int)comboRatings[combo.Id].ReviewCount : 0;
                    
                    <div class="menu-card combo-card animate-scale-in" style="animation-delay: @(delay)s;" onclick="openComboModal(@combo.Id)">
                        <!-- Badge -->
                        <span class="combo-badge">üî• HOT</span>
                        
                        <!-- Image -->
                        <div class="card-image">
                            <img src="@combo.ImageUrl" alt="@combo.Name" onerror="this.src='/images/no-image.png'" loading="lazy" />
                            <div class="card-overlay">
                                <span class="view-detail">üëÅÔ∏è Xem chi ti·∫øt</span>
                            </div>
                        </div>
                        
                        <!-- Info -->
                        <div class="card-content">
                            <h3 class="card-title">@combo.Name</h3>
                            
                            <!-- Rating -->
                            <div class="card-rating">
                                @if (reviewCount > 0)
                                {
                                    <div class="rating-stars">
                                        @for (int i = 1; i <= 5; i++)
                                        {
                                            if (i <= Math.Round(avgRating))
                                            {
                                                <span class="star filled">‚òÖ</span>
                                            }
                                            else
                                            {
                                                <span class="star empty">‚òÜ</span>
                                            }
                                        }
                                    </div>
                                    <span class="rating-text">@avgRating.ToString("0.0")</span>
                                    <span class="review-count">(@reviewCount ƒë√°nh gi√°)</span>
                                }
                                else
                                {
                                    <span class="no-rating">Ch∆∞a c√≥ ƒë√°nh gi√°</span>
                                }
                            </div>
                            
                            <p class="card-description">@(combo.Description?.Length > 60 ? combo.Description.Substring(0, 60) + "..." : combo.Description)</p>
                            
                            <div class="card-footer">
                                <div class="card-price">
                                    <span class="price-value">@combo.Price.ToString("N0")</span>
                                    <span class="price-unit">‚Ç´</span>
                                </div>
                                <button class="card-add-btn" onclick="event.stopPropagation(); addComboToCart(@combo.Id)">
                                    <span>üõí</span> Th√™m
                                </button>
                            </div>
                        </div>
                    </div>
                    delay += 0.05;
                    if (delay > 0.5) delay = 0;
                }
            }
        </div>

        <!-- PAGINATION -->
        @if (totalPages > 1)
        {
            <div class="pagination-container animate-fade-in">
                <div class="pagination-info">
                    Trang <strong>@currentPage</strong> / <strong>@totalPages</strong>
                </div>
                <div class="pagination-nav">
                    @if (currentPage > 1)
                    {
                        <a href="@Url.Action("Index", new { keyword, sortBy, minPrice, maxPrice, minRating, page = currentPage - 1 })" class="page-btn">
                            ‚Üê Tr∆∞·ªõc
                        </a>
                    }
                    
                    @for (int i = 1; i <= totalPages; i++)
                    {
                        if (i == currentPage)
                        {
                            <span class="page-btn active">@i</span>
                        }
                        else if (i == 1 || i == totalPages || (i >= currentPage - 1 && i <= currentPage + 1))
                        {
                            <a href="@Url.Action("Index", new { keyword, sortBy, minPrice, maxPrice, minRating, page = i })" class="page-btn">@i</a>
                        }
                        else if (i == currentPage - 2 || i == currentPage + 2)
                        {
                            <span class="page-dots">...</span>
                        }
                    }
                    
                    @if (currentPage < totalPages)
                    {
                        <a href="@Url.Action("Index", new { keyword, sortBy, minPrice, maxPrice, minRating, page = currentPage + 1 })" class="page-btn">
                            Sau ‚Üí
                        </a>
                    }
                </div>
            </div>
        }
    </div>
</div>

<!-- POPUP MODAL -->
<div id="comboModal" class="modal-overlay" style="display:none;">
    <div class="modal-content">
        <span class="close-btn" onclick="closeComboModal()">√ó</span>
        <div id="comboModalBody"></div>
    </div>
</div>