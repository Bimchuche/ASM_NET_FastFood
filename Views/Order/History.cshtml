@model List<ASM1_NET.Models.Order>
@{
    ViewData["Title"] = "L·ªãch s·ª≠ ƒë∆°n h√†ng";
    var pendingCount = Model.Count(o => o.Status == "Pending");
    var deliveringCount = Model.Count(o => o.Status == "Delivering");
    var completedCount = Model.Count(o => o.Status == "Completed");
    var totalSpent = Model.Where(o => o.Status == "Completed").Sum(o => o.TotalAmount);
}

<link rel="stylesheet" href="~/client/css/menu.css" />

<div class="order-history-page">
    <div class="container">
        <!-- HERO -->
        <div class="order-hero animate-fade-in">
            <h1>üì¶ L·ªãch s·ª≠ ƒë∆°n h√†ng</h1>
            <p>Theo d√µi t·∫•t c·∫£ ƒë∆°n h√†ng c·ªßa b·∫°n</p>
        </div>
        
        <!-- STATS -->
        <div class="order-stats animate-slide-up">
            <div class="order-stat-card">
                <div class="stat-icon">‚è≥</div>
                <div class="stat-value">@pendingCount</div>
                <div class="stat-label">ƒêang ch·ªù</div>
            </div>
            <div class="order-stat-card">
                <div class="stat-icon">üöö</div>
                <div class="stat-value">@deliveringCount</div>
                <div class="stat-label">ƒêang giao</div>
            </div>
            <div class="order-stat-card">
                <div class="stat-icon">‚úÖ</div>
                <div class="stat-value">@completedCount</div>
                <div class="stat-label">Ho√†n th√†nh</div>
            </div>
            <div class="order-stat-card">
                <div class="stat-icon">üí∞</div>
                <div class="stat-value">@totalSpent.ToString("N0")‚Ç´</div>
                <div class="stat-label">T·ªïng chi ti√™u</div>
            </div>
        </div>
        
        <!-- ORDER TABLE -->
        @if (!Model.Any())
        {
            <div class="menu-empty-state animate-fade-in">
                <div class="empty-icon">üì¶</div>
                <h3>B·∫°n ch∆∞a c√≥ ƒë∆°n h√†ng n√†o</h3>
                <p>H√£y ƒë·∫∑t h√†ng ngay ƒë·ªÉ tr·∫£i nghi·ªám d·ªãch v·ª• c·ªßa ch√∫ng t√¥i!</p>
                <a href="/Food" class="btn btn-primary btn-lg rounded-pill px-4">üçï Xem menu</a>
            </div>
        }
        else
        {
            <div class="order-table-card animate-slide-up">
                <div class="order-table-header">
                    <h3>üìã Danh s√°ch ƒë∆°n h√†ng</h3>
                </div>
                
                <table class="order-table">
                    <thead>
                        <tr>
                            <th>M√£ ƒë∆°n</th>
                            <th>Ng√†y ƒë·∫∑t</th>
                            <th>ƒê·ªãa ch·ªâ</th>
                            <th>T·ªïng ti·ªÅn</th>
                            <th>Ph∆∞∆°ng th·ª©c thanh to√°n</th>
                            <th>Tr·∫°ng th√°i</th>
                            <th>H√†nh ƒë·ªông</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var order in Model.OrderByDescending(o => o.OrderDate))
                        {
                            var statusClass = order.Status switch
                            {
                                "Pending" => "pending",
                                "Delivering" => "delivering",
                                "Completed" => "completed",
                                "Cancelled" => "cancelled",
                                _ => "pending"
                            };
                            var statusIcon = order.Status switch
                            {
                                "Pending" => "‚è≥",
                                "Delivering" => "üöö",
                                "Completed" => "‚úÖ",
                                "Cancelled" => "‚ùå",
                                _ => "üì¶"
                            };
                            var statusText = order.Status switch
                            {
                                "Pending" => "ƒêang ch·ªù",
                                "Delivering" => "ƒêang giao",
                                "Completed" => "Ho√†n th√†nh",
                                "Cancelled" => "ƒê√£ h·ªßy",
                                _ => order.Status
                            };
                            
                            <tr class="animate-fade-in">
                                <td>
                                    <strong style="color: #60a5fa;">#@order.OrderCode</strong>
                                </td>
                                <td>@order.OrderDate.ToString("dd/MM/yyyy HH:mm")</td>
                                <td>
                                    <span style="max-width: 200px; display: inline-block; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                                        üìç @order.Address
                                    </span>
                                </td>
                                <td>
                                    <strong style="color: #fbbf24;">@order.TotalAmount.ToString("N0") ‚Ç´</strong>
                                </td>
                                <td>
                                    @if (order.PaymentMethod == "QR")
                                    {
                                        <span class="order-payment-label qr">üì± QR</span>
                                    }
                                    else
                                    {
                                        <span class="order-payment-label cod">üíµ COD</span>
                                    }
                                </td>
                                <td>
                                    <span class="order-status @statusClass">
                                        @statusIcon @statusText
                                    </span>
                                </td>
                                <td>
                                    <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                                        <a asp-action="Success" asp-route-id="@order.Id" class="order-action-btn primary">
                                            üëÅÔ∏è Xem
                                        </a>
                                        @if (order.Status == "Completed")
                                        {
                                            <a asp-controller="Review" asp-action="Create" asp-route-orderId="@order.Id" 
                                               class="order-action-btn" style="background: linear-gradient(135deg, #f59e0b, #d97706); color: white;">
                                                ‚≠ê ƒê√°nh gi√°
                                            </a>
                                        }
                                        @if (order.Status == "Pending" || order.Status == "ƒê√£ thanh to√°n" || order.Status == "ƒêang x·ª≠ l√Ω")
                                        {
                                            var cancelMessage = order.PaymentMethod == "QR" && order.PaymentStatus == "Paid" 
                                                ? "B·∫°n c√≥ ch·∫Øc mu·ªën h·ªßy ƒë∆°n h√†ng n√†y? Ti·ªÅn s·∫Ω ƒë∆∞·ª£c ho√†n l·∫°i qua PayOS." 
                                                : "B·∫°n c√≥ ch·∫Øc mu·ªën h·ªßy ƒë∆°n h√†ng n√†y?";
                                            <form asp-action="Cancel" method="post" style="display: inline;">
                                                <input type="hidden" name="id" value="@order.Id" />
                                                <button type="submit" class="order-action-btn cancel" 
                                                        onclick="return confirm('@cancelMessage');">
                                                    ‚ùå H·ªßy
                                                </button>
                                            </form>
                                        }
                                    </div>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        }
    </div>
</div>

<script src="~/client/js/order-history.js"></script>