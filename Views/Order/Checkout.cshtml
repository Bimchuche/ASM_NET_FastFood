@model ASM1_NET.Models.Cart
@{
    ViewData["Title"] = "Thanh to√°n";
    var totalAmount = Model?.CartItems?.Sum(i => i.Price * i.Quantity) ?? 0;
    var totalItems = Model?.CartItems?.Sum(i => i.Quantity) ?? 0;
}

<link rel="stylesheet" href="~/client/css/checkout.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<link rel="stylesheet" href="~/client/css/address-picker.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="~/client/js/address-picker.js"></script>

<div class="checkout-page">
    <div class="container">
        <!-- HERO -->
        <div class="checkout-hero">
            <h1>üßæ Thanh to√°n ƒë∆°n h√†ng</h1>
            <p>X√°c nh·∫≠n th√¥ng tin v√† ho√†n t·∫•t ƒë∆°n h√†ng c·ªßa b·∫°n</p>
        </div>
        
        @if (Model == null || Model.CartItems == null || !Model.CartItems.Any())
        {
            <div class="checkout-card">
                <div class="checkout-empty">
                    <div class="icon">üõí</div>
                    <h3>Gi·ªè h√†ng tr·ªëng</h3>
                    <p>Kh√¥ng th·ªÉ thanh to√°n khi ch∆∞a c√≥ s·∫£n ph·∫©m</p>
                    <a href="/Food" class="btn-checkout-submit" style="display: inline-block; padding: 15px 40px;">
                        üçï Xem Menu
                    </a>
                </div>
            </div>
        }
        else
        {
            <form method="post" asp-controller="Order" asp-action="Checkout" id="checkoutForm" novalidate>
                <div class="checkout-grid">
                    <!-- LEFT: Order Details -->
                    <div>
                        <!-- Order Items -->
                        <div class="checkout-card" style="margin-bottom: 25px;">
                            <div class="checkout-card-header">
                                <h3>üì¶ S·∫£n ph·∫©m ƒë√£ ch·ªçn (@totalItems)</h3>
                            </div>
                            <div class="checkout-card-body">
                                @foreach (var item in Model.CartItems)
                                {
                                    var itemName = item.Food?.Name ?? item.Combo?.Name ?? "S·∫£n ph·∫©m";
                                    var itemImage = item.Food?.ImageUrl ?? item.Combo?.ImageUrl ?? "";
                                    var isCombo = item.ComboId.HasValue;
                                    var subtotal = item.Price * item.Quantity;
                                    
                                    <div class="checkout-item">
                                        <div class="checkout-item-image">
                                            @if (!string.IsNullOrEmpty(itemImage))
                                            {
                                                <img src="@itemImage" alt="@itemName" onerror="this.parentElement.innerHTML='üçî'" />
                                            }
                                            else
                                            {
                                                <span>@(isCombo ? "üéÅ" : "üçî")</span>
                                            }
                                        </div>
                                        <div class="checkout-item-info">
                                            <span class="checkout-item-name">@itemName</span>
                                            <span class="checkout-item-type @(isCombo ? "combo" : "food")">
                                                @(isCombo ? "COMBO" : "M√ìN ƒÇN")
                                            </span>
                                            <span class="checkout-item-qty">√ó@item.Quantity ‚Ä¢ @item.Price.ToString("N0")‚Ç´/m√≥n</span>
                                        </div>
                                        <span class="checkout-item-price">@subtotal.ToString("N0")‚Ç´</span>
                                    </div>
                                }
                            </div>
                        </div>
                        
                        <!-- Delivery Info -->
                        <div class="checkout-card">
                            <div class="checkout-card-header">
                                <h3>üöö Th√¥ng tin giao h√†ng</h3>
                            </div>
                            <div class="checkout-card-body">
                                <!-- Address Type Selector -->
                                @if (!string.IsNullOrEmpty(ViewBag.UserAddress))
                                {
                                    <div class="address-type-selector">
                                        <div class="address-type-option active" onclick="selectAddressType('saved', this)">
                                            <span class="icon">üè†</span>
                                            <span class="label">ƒê·ªãa ch·ªâ ƒë√£ l∆∞u</span>
                                            <span class="desc">Giao ƒë·∫øn ƒë·ªãa ch·ªâ c·ªßa b·∫°n</span>
                                        </div>
                                        <div class="address-type-option" onclick="selectAddressType('new', this)">
                                            <span class="icon">üìç</span>
                                            <span class="label">ƒê·ªãa ch·ªâ kh√°c</span>
                                            <span class="desc">Ch·ªçn ƒë·ªãa ch·ªâ m·ªõi</span>
                                        </div>
                                    </div>
                                    
                                    <!-- Saved Address Display -->
                                    <div class="saved-address-display" id="savedAddressDisplay">
                                        <span class="icon">‚úÖ</span>
                                        <span class="address-text">@ViewBag.UserAddress</span>
                                    </div>
                                    
                                    <!-- Hidden input for saved address -->
                                    <input type="hidden" name="addressType" id="addressType" value="saved" />
                                    <input type="hidden" id="savedAddress" value="@ViewBag.UserAddress" />
                                }
                                
                                <!-- New Address Section (with Map) -->
                                <div class="new-address-section @(string.IsNullOrEmpty(ViewBag.UserAddress) ? "active" : "")" id="newAddressSection">
                                    <div class="checkout-form-group">
                                        <label class="checkout-label">
                                            <span class="icon">üìç</span>ƒê·ªãa ch·ªâ giao h√†ng
                                        </label>
                                        <div class="address-input-wrapper">
                                            <input type="text" name="address" id="addressInput" class="checkout-input" 
                                                   placeholder="Nh·∫≠p ƒë·ªãa ch·ªâ ho·∫∑c ch·ªçn tr√™n b·∫£n ƒë·ªì..." 
                                                   @(string.IsNullOrEmpty(ViewBag.UserAddress) ? "required" : "") />
                                            <input type="hidden" name="latitude" id="addressLatitude" />
                                            <input type="hidden" name="longitude" id="addressLongitude" />
                                            <div class="address-suggestions" id="addressSuggestions"></div>
                                        </div>
                                    </div>
                                    
                                    <!-- Leaflet Map -->
                                    <div class="address-map-container">
                                        <div id="checkoutMap" class="address-map"></div>
                                        <button type="button" class="btn-current-location" onclick="getCurrentLocation('addressInput')">
                                            üìç V·ªã tr√≠ hi·ªán t·∫°i
                                        </button>
                                    </div>
                                </div>
                                
                                <div class="checkout-form-group">
                                    <label class="checkout-label">
                                        <span class="icon">üìû</span>S·ªë ƒëi·ªán tho·∫°i
                                    </label>
                                    <input type="tel" name="phone" class="checkout-input" 
                                           value="@ViewBag.UserPhone"
                                           placeholder="Nh·∫≠p s·ªë ƒëi·ªán tho·∫°i li√™n h·ªá..." required />
                                </div>
                                
                                <div class="checkout-form-group">
                                    <label class="checkout-label">
                                        <span class="icon">üìù</span>Ghi ch√∫ (t√πy ch·ªçn)
                                    </label>
                                    <input type="text" name="note" class="checkout-input" 
                                           placeholder="Ghi ch√∫ cho ƒë∆°n h√†ng (v√≠ d·ª•: giao gi·ªù h√†nh ch√≠nh)..." />
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- RIGHT: Payment & Summary -->
                    <div>
                        <!-- Payment Methods -->
                        <div class="checkout-card" style="margin-bottom: 25px;">
                            <div class="checkout-card-header">
                                <h3>üí≥ Ph∆∞∆°ng th·ª©c thanh to√°n</h3>
                            </div>
                            <div class="checkout-card-body">
                                <div class="payment-methods">
                                    <label class="payment-method active" onclick="selectPayment(this, 'cod')">
                                        <input type="radio" name="paymentMethod" value="COD" checked />
                                        <span class="radio-custom"></span>
                                        <span class="payment-method-icon">üíµ</span>
                                        <div class="payment-method-info">
                                            <h4>Thanh to√°n khi nh·∫≠n h√†ng</h4>
                                            <p>Tr·∫£ ti·ªÅn m·∫∑t cho shipper</p>
                                        </div>
                                    </label>
                                    
                                    <label class="payment-method" onclick="selectPayment(this, 'qr')">
                                        <input type="radio" name="paymentMethod" value="QR" />
                                        <span class="radio-custom"></span>
                                        <span class="payment-method-icon">üì±</span>
                                        <div class="payment-method-info">
                                            <h4>Chuy·ªÉn kho·∫£n QR</h4>
                                            <p>Qu√©t m√£ QR ƒë·ªÉ thanh to√°n</p>
                                        </div>
                                    </label>
                                
                                <!-- QR Code Section -->
                                <div id="qrSection" class="qr-section">
                                    <div class="qr-code">
                                        <img src="https://api.qrserver.com/v1/create-qr-code/?size=180x180&data=FastFood-Order-@totalAmount" alt="QR Code" />
                                    </div>
                                    <div class="qr-info">
                                        <p>Qu√©t m√£ QR ƒë·ªÉ thanh to√°n</p>
                                        <p>S·ªë ti·ªÅn: <strong>@totalAmount.ToString("N0")‚Ç´</strong></p>
                                        <p style="font-size: 0.8rem; margin-top: 10px;">
                                            Ng√¢n h√†ng: <strong>Vietcombank</strong><br/>
                                            STK: <strong>1234567890</strong><br/>
                                            Ch·ªß TK: <strong>FASTFOOD VN</strong>
                                        </p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Order Summary -->
                        <div class="checkout-card">
                            <div class="checkout-card-header">
                                <h3>üìã T√≥m t·∫Øt ƒë∆°n h√†ng</h3>
                            </div>
                            <div class="checkout-card-body">
                                <div class="checkout-summary">
                                    <div class="checkout-summary-row">
                                        <span>T·∫°m t√≠nh (@totalItems m√≥n)</span>
                                        <span>@totalAmount.ToString("N0")‚Ç´</span>
                                    </div>
                                    <div class="checkout-summary-row">
                                        <span>Ph√≠ giao h√†ng</span>
                                        <span style="color: #22c55e;">Mi·ªÖn ph√≠</span>
                                    </div>
                                    <div class="checkout-summary-row">
                                        <span>Gi·∫£m gi√°</span>
                                        <span>0‚Ç´</span>
                                    </div>
                                    <div class="checkout-summary-row total">
                                        <span>T·ªïng c·ªông</span>
                                        <span>@totalAmount.ToString("N0")‚Ç´</span>
                                    </div>
                                </div>
                                
                                <div class="checkout-actions">
                                    <button type="submit" class="btn-checkout-submit">
                                        ‚úÖ X√°c nh·∫≠n ƒë·∫∑t h√†ng
                                    </button>
                                    <a href="/Cart" class="btn-checkout-back">
                                        ‚Üê Quay l·∫°i gi·ªè h√†ng
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </form>
        }
    </div>
</div>

<script>
    // Initialize map if no saved address (always show map)
    document.addEventListener('DOMContentLoaded', function() {
        const newSection = document.getElementById('newAddressSection');
        if (newSection && newSection.classList.contains('active')) {
            setTimeout(() => {
                initAddressMap('checkoutMap', 'addressInput', { lat: 10.8231, lng: 106.6297, zoom: 13 });
                initAddressAutocomplete('addressInput', 'addressSuggestions');
                window.addressMapInitialized = true;
            }, 100);
        }
    });

    function selectPayment(element, type) {
        // Remove active from all
        document.querySelectorAll('.payment-method').forEach(el => el.classList.remove('active'));
        // Add active to clicked
        element.classList.add('active');
        // Check radio
        element.querySelector('input[type="radio"]').checked = true;
        
        // Show/hide QR section
        const qrSection = document.getElementById('qrSection');
        if (type === 'qr') {
            qrSection.classList.add('active');
        } else {
            qrSection.classList.remove('active');
        }
    }
    
    // Address type toggle
    function selectAddressType(type, element) {
        // Update active class
        document.querySelectorAll('.address-type-option').forEach(el => el.classList.remove('active'));
        element.classList.add('active');
        
        // Update hidden input
        document.getElementById('addressType').value = type;
        
        // Show/hide sections
        const savedDisplay = document.getElementById('savedAddressDisplay');
        const newSection = document.getElementById('newAddressSection');
        const addressInput = document.getElementById('addressInput');
        
        if (type === 'saved') {
            savedDisplay.style.display = 'block';
            newSection.classList.remove('active');
            // Remove required to prevent validation error on hidden field
            addressInput.removeAttribute('required');
            addressInput.value = ''; // clear value
        } else {
            savedDisplay.style.display = 'none';
            newSection.classList.add('active');
            addressInput.setAttribute('required', 'required');
            
            // Initialize map if not already
            if (!window.addressMapInitialized) {
                setTimeout(() => {
                    initAddressMap('checkoutMap', 'addressInput', { lat: 10.8231, lng: 106.6297, zoom: 13 });
                    initAddressAutocomplete('addressInput', 'addressSuggestions');
                    window.addressMapInitialized = true;
                }, 100);
            }
        }
    }
    
    // Handle form submit
    const checkoutForm = document.getElementById('checkoutForm');
    if (checkoutForm) {
        checkoutForm.addEventListener('submit', function(e) {
            const addressType = document.getElementById('addressType');
            const phone = document.querySelector('input[name="phone"]');
            
            // Basic validation
            if (!phone.value.trim()) {
                e.preventDefault();
                showToast('Vui l√≤ng nh·∫≠p s·ªë ƒëi·ªán tho·∫°i!', 'error');
                return;
            }

            if (addressType && addressType.value === 'saved') {
                // Case 1: Saved Address
                const savedAddress = document.getElementById('savedAddress').value;
                const addressInput = document.getElementById('addressInput');
                
                // FORCE: populate saved address to the input that controller expects
                if (addressInput) {
                    addressInput.removeAttribute('required'); // Ensure no validation blocks it
                    addressInput.value = savedAddress;
                } else {
                    // Fallback
                    const hidden = document.createElement('input');
                    hidden.type = 'hidden';
                    hidden.name = 'address';
                    hidden.value = savedAddress;
                    this.appendChild(hidden);
                }
            } else {
                // Case 2: New Address
                 const addressInput = document.getElementById('addressInput');
                 if (!addressInput.value.trim()) {
                     e.preventDefault();
                     showToast('Vui l√≤ng nh·∫≠p ƒë·ªãa ch·ªâ giao h√†ng!', 'error');
                     return;
                 }
            }
            // If all good, form submits naturally
        });
    }
</script>

@section Styles {
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="~/client/css/address-picker.css" />
}

@section Scripts {
    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="~/client/js/address-picker.js"></script>
}