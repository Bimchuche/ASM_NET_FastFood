@model ASM1_NET.Models.Cart
@{
    ViewData["Title"] = "Thanh to√°n";
    var totalAmount = Model?.CartItems?.Sum(i => i.Price * i.Quantity) ?? 0;
    var totalItems = Model?.CartItems?.Sum(i => i.Quantity) ?? 0;
}

<link rel="stylesheet" href="~/client/css/checkout.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<link rel="stylesheet" href="~/client/css/address-picker.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="~/client/js/address-picker.js"></script>

<div class="checkout-page">
    <div class="container">
        <!-- HERO -->
        <div class="checkout-hero">
            <h1>üßæ Thanh to√°n ƒë∆°n h√†ng</h1>
            <p>X√°c nh·∫≠n th√¥ng tin v√† ho√†n t·∫•t ƒë∆°n h√†ng c·ªßa b·∫°n</p>
        </div>
        
        @if (Model == null || Model.CartItems == null || !Model.CartItems.Any())
        {
            <div class="checkout-card">
                <div class="checkout-empty">
                    <div class="icon">üõí</div>
                    <h3>Gi·ªè h√†ng tr·ªëng</h3>
                    <p>Kh√¥ng th·ªÉ thanh to√°n khi ch∆∞a c√≥ s·∫£n ph·∫©m</p>
                    <a href="/Food" class="btn-checkout-submit" style="display: inline-block; padding: 15px 40px;">
                        üçï Xem Menu
                    </a>
                </div>
            </div>
        }
        else
        {
            <form method="post" asp-controller="Order" asp-action="Checkout" id="checkoutForm" novalidate>
                <div class="checkout-grid">
                    <!-- LEFT: Order Details -->
                    <div>
                        <!-- Order Items -->
                        <div class="checkout-card" style="margin-bottom: 25px;">
                            <div class="checkout-card-header">
                                <h3>üì¶ S·∫£n ph·∫©m ƒë√£ ch·ªçn (@totalItems)</h3>
                            </div>
                            <div class="checkout-card-body">
                                @foreach (var item in Model.CartItems)
                                {
                                    var itemName = item.Food?.Name ?? item.Combo?.Name ?? "S·∫£n ph·∫©m";
                                    var itemImage = item.Food?.ImageUrl ?? item.Combo?.ImageUrl ?? "";
                                    var isCombo = item.ComboId.HasValue;
                                    var subtotal = item.Price * item.Quantity;
                                    
                                    <div class="checkout-item">
                                        <div class="checkout-item-image">
                                            @if (!string.IsNullOrEmpty(itemImage))
                                            {
                                                <img src="@itemImage" alt="@itemName" onerror="this.parentElement.innerHTML='üçî'" />
                                            }
                                            else
                                            {
                                                <span>@(isCombo ? "üéÅ" : "üçî")</span>
                                            }
                                        </div>
                                        <div class="checkout-item-info">
                                            <span class="checkout-item-name">@itemName</span>
                                            <span class="checkout-item-type @(isCombo ? "combo" : "food")">
                                                @(isCombo ? "COMBO" : "M√ìN ƒÇN")
                                            </span>
                                            <span class="checkout-item-qty">√ó@item.Quantity ‚Ä¢ @item.Price.ToString("N0")‚Ç´/m√≥n</span>
                                        </div>
                                        <span class="checkout-item-price">@subtotal.ToString("N0")‚Ç´</span>
                                    </div>
                                }
                            </div>
                        </div>
                        
                        <!-- Delivery Info -->
                        <div class="checkout-card">
                            <div class="checkout-card-header">
                                <h3>üöö Th√¥ng tin giao h√†ng</h3>
                            </div>
                            <div class="checkout-card-body">
                                <!-- Address Type Selector -->
                                @{
                                    var savedAddresses = ViewBag.SavedAddresses as List<ASM1_NET.Models.UserAddress>;
                                    var hasAddresses = savedAddresses != null && savedAddresses.Count > 0;
                                }
                                
                                @if (hasAddresses)
                                {
                                    <div class="address-type-selector">
                                        <div class="address-type-option active" onclick="selectAddressType('saved', this)">
                                            <span class="icon">üè†</span>
                                            <span class="label">ƒê·ªãa ch·ªâ ƒë√£ l∆∞u</span>
                                            <span class="desc">Ch·ªçn t·ª´ @savedAddresses.Count ƒë·ªãa ch·ªâ</span>
                                        </div>
                                        <div class="address-type-option" onclick="selectAddressType('new', this)">
                                            <span class="icon">üìç</span>
                                            <span class="label">ƒê·ªãa ch·ªâ kh√°c</span>
                                            <span class="desc">Nh·∫≠p ƒë·ªãa ch·ªâ m·ªõi</span>
                                        </div>
                                    </div>
                                    
                                    <!-- Saved Addresses Dropdown -->
                                    <div class="saved-address-section" id="savedAddressDisplay">
                                        <div class="checkout-form-group">
                                            <label class="checkout-label">
                                                <span class="icon">üìç</span>Ch·ªçn ƒë·ªãa ch·ªâ giao h√†ng
                                            </label>
                                            <select name="savedAddressId" id="savedAddressSelect" class="checkout-input"
                                                    style="cursor: pointer;" onchange="onSavedAddressChange(this)">
                                                @foreach (var addr in savedAddresses)
                                                {
                                                    if (addr.IsDefault)
                                                    {
                                                        <option value="@addr.Id" selected
                                                                data-address="@addr.FullAddress" 
                                                                data-phone="@addr.Phone"
                                                                data-lat="@addr.Latitude"
                                                                data-lng="@addr.Longitude">
                                                            @addr.Name - @(addr.FullAddress.Length > 50 ? addr.FullAddress.Substring(0, 50) + "..." : addr.FullAddress)
                                                        </option>
                                                    }
                                                    else
                                                    {
                                                        <option value="@addr.Id"
                                                                data-address="@addr.FullAddress" 
                                                                data-phone="@addr.Phone"
                                                                data-lat="@addr.Latitude"
                                                                data-lng="@addr.Longitude">
                                                            @addr.Name - @(addr.FullAddress.Length > 50 ? addr.FullAddress.Substring(0, 50) + "..." : addr.FullAddress)
                                                        </option>
                                                    }
                                                }
                                            </select>
                                        </div>
                                        <div class="selected-address-display" id="selectedAddressText">
                                            ‚úÖ @(ViewBag.DefaultAddress != null ? ((ASM1_NET.Models.UserAddress)ViewBag.DefaultAddress).FullAddress : ViewBag.UserAddress)
                                        </div>
                                        <a href="/Address" class="manage-addresses-link">‚öôÔ∏è Qu·∫£n l√Ω ƒë·ªãa ch·ªâ</a>
                                    </div>
                                    
                                    <!-- Hidden input for saved address -->
                                    <input type="hidden" name="addressType" id="addressType" value="saved" />
                                    <input type="hidden" id="savedAddress" value="@ViewBag.UserAddress" />
                                }
                                else if (!string.IsNullOrEmpty(ViewBag.UserAddress))
                                {
                                    <div class="address-type-selector">
                                        <div class="address-type-option active" onclick="selectAddressType('saved', this)">
                                            <span class="icon">üè†</span>
                                            <span class="label">ƒê·ªãa ch·ªâ ƒë√£ l∆∞u</span>
                                            <span class="desc">Giao ƒë·∫øn ƒë·ªãa ch·ªâ c·ªßa b·∫°n</span>
                                        </div>
                                        <div class="address-type-option" onclick="selectAddressType('new', this)">
                                            <span class="icon">üìç</span>
                                            <span class="label">ƒê·ªãa ch·ªâ kh√°c</span>
                                            <span class="desc">Ch·ªçn ƒë·ªãa ch·ªâ m·ªõi</span>
                                        </div>
                                    </div>
                                    
                                    <!-- Saved Address Display -->
                                    <div class="saved-address-display" id="savedAddressDisplay">
                                        <span class="icon">‚úÖ</span>
                                        <span class="address-text">@ViewBag.UserAddress</span>
                                    </div>
                                    
                                    <!-- Hidden input for saved address -->
                                    <input type="hidden" name="addressType" id="addressType" value="saved" />
                                    <input type="hidden" id="savedAddress" value="@ViewBag.UserAddress" />
                                }
                                
                                <!-- New Address Section (with Map) -->
                                <div class="new-address-section @(string.IsNullOrEmpty(ViewBag.UserAddress) ? "active" : "")" id="newAddressSection">
                                    <div class="checkout-form-group">
                                        <label class="checkout-label">
                                            <span class="icon">üìç</span>ƒê·ªãa ch·ªâ giao h√†ng
                                        </label>
                                        <div class="address-input-wrapper">
                                            <input type="text" name="address" id="addressInput" class="checkout-input" 
                                                   placeholder="Nh·∫≠p ƒë·ªãa ch·ªâ ho·∫∑c ch·ªçn tr√™n b·∫£n ƒë·ªì..." 
                                                   @(string.IsNullOrEmpty(ViewBag.UserAddress) ? "required" : "") />
                                            <input type="hidden" name="latitude" id="addressLatitude" />
                                            <input type="hidden" name="longitude" id="addressLongitude" />
                                            <div class="address-suggestions" id="addressSuggestions"></div>
                                        </div>
                                    </div>
                                    
                                    <!-- Leaflet Map -->
                                    <div class="address-map-container">
                                        <div id="checkoutMap" class="address-map"></div>
                                        <button type="button" class="btn-current-location" onclick="getCurrentLocation('addressInput')">
                                            üìç V·ªã tr√≠ hi·ªán t·∫°i
                                        </button>
                                    </div>
                                </div>
                                
                                <div class="checkout-form-group">
                                    <label class="checkout-label">
                                        <span class="icon">üìû</span>S·ªë ƒëi·ªán tho·∫°i
                                    </label>
                                    <input type="tel" name="phone" class="checkout-input" 
                                           value="@ViewBag.UserPhone"
                                           placeholder="Nh·∫≠p s·ªë ƒëi·ªán tho·∫°i li√™n h·ªá..." required />
                                </div>
                                
                                <div class="checkout-form-group">
                                    <label class="checkout-label">
                                        <span class="icon">üìù</span>Ghi ch√∫ (t√πy ch·ªçn)
                                    </label>
                                    <input type="text" name="note" class="checkout-input" 
                                           placeholder="Ghi ch√∫ cho ƒë∆°n h√†ng (v√≠ d·ª•: giao gi·ªù h√†nh ch√≠nh)..." />
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- RIGHT: Payment & Summary -->
                    <div>
                        <!-- Payment Methods -->
                        <div class="checkout-card" style="margin-bottom: 25px;">
                            <div class="checkout-card-header">
                                <h3>üí≥ Ph∆∞∆°ng th·ª©c thanh to√°n</h3>
                            </div>
                            <div class="checkout-card-body">
                                <div class="payment-methods">
                                    <label class="payment-method active" onclick="selectPayment(this, 'cod')">
                                        <input type="radio" name="paymentMethod" value="COD" checked />
                                        <span class="radio-custom"></span>
                                        <span class="payment-method-icon">üíµ</span>
                                        <div class="payment-method-info">
                                            <h4>Thanh to√°n khi nh·∫≠n h√†ng</h4>
                                            <p>Tr·∫£ ti·ªÅn m·∫∑t cho shipper</p>
                                        </div>
                                    </label>
                                    
                                    <label class="payment-method" onclick="selectPayment(this, 'qr')">
                                        <input type="radio" name="paymentMethod" value="QR" />
                                        <span class="radio-custom"></span>
                                        <span class="payment-method-icon">üì±</span>
                                        <div class="payment-method-info">
                                            <h4>Thanh to√°n QR (PayOS)</h4>
                                            <p>Chuy·ªÉn ƒë·∫øn trang thanh to√°n an to√†n</p>
                                        </div>
                                    </label>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Coupon Code -->
                        <div class="checkout-card" style="margin-bottom: 25px;">
                            <div class="checkout-card-header">
                                <h3>üéüÔ∏è M√£ gi·∫£m gi√°</h3>
                            </div>
                            <div class="checkout-card-body">
                                <div class="coupon-input-wrapper">
                                    <input type="text" id="couponCode" name="couponCode" 
                                           placeholder="Nh·∫≠p m√£ gi·∫£m gi√°..." 
                                           style="text-transform: uppercase; font-family: monospace;" />
                                    <button type="button" id="applyCouponBtn" onclick="applyCoupon()">
                                        √Åp d·ª•ng
                                    </button>
                                </div>
                                <div id="couponMessage" style="margin-top: 10px; font-size: 0.9rem;"></div>
                                <input type="hidden" id="discountAmount" name="discountAmount" value="0" />
                                <input type="hidden" id="couponId" name="couponId" value="" />
                            </div>
                        </div>
                        
                        <!-- Order Summary -->
                        <div class="checkout-card">
                            <div class="checkout-card-header">
                                <h3>üìã T√≥m t·∫Øt ƒë∆°n h√†ng</h3>
                            </div>
                            <div class="checkout-card-body">
                                <div class="checkout-summary">
                                    <div class="checkout-summary-row">
                                        <span>T·∫°m t√≠nh (@totalItems m√≥n)</span>
                                        <span id="subtotalDisplay">@totalAmount.ToString("N0")‚Ç´</span>
                                    </div>
                                    <div class="checkout-summary-row" id="distanceRow" style="color: #94a3b8;">
                                        <span>üìç Kho·∫£ng c√°ch giao</span>
                                        <span id="distanceDisplay">Ch·ªçn ƒë·ªãa ch·ªâ...</span>
                                    </div>
                                    <div class="checkout-summary-row" id="shippingRow">
                                        <span>Ph√≠ giao h√†ng</span>
                                        <span id="shippingFeeDisplay" style="color: #94a3b8;">Ch·ªçn ƒë·ªãa ch·ªâ...</span>
                                    </div>
                                    <div class="checkout-summary-row" id="discountRow">
                                        <span>Gi·∫£m gi√°</span>
                                        <span id="discountDisplay">-0‚Ç´</span>
                                    </div>
                                    <div class="checkout-summary-row total">
                                        <span>T·ªïng c·ªông</span>
                                        <span id="totalDisplay">@totalAmount.ToString("N0")‚Ç´</span>
                                    </div>
                                    <input type="hidden" id="shippingFee" name="shippingFee" value="0" />
                                    <input type="hidden" id="subtotal" value="@totalAmount" />
                                </div>

                                <div class="checkout-actions">
                                    <button type="submit" id="submitBtn" class="btn-checkout-submit">
                                        ‚úÖ X√°c nh·∫≠n ƒë·∫∑t h√†ng
                                    </button>
                                    <a href="/Cart" class="btn-checkout-back">
                                        ‚Üê Quay l·∫°i gi·ªè h√†ng
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </form>
        }
    </div>
</div>

<script>
    // Initialize map if no saved address (always show map)
    document.addEventListener('DOMContentLoaded', function() {
        const newSection = document.getElementById('newAddressSection');
        if (newSection && newSection.classList.contains('active')) {
            setTimeout(() => {
                initAddressMap('checkoutMap', 'addressInput', { lat: 10.8231, lng: 106.6297, zoom: 13 });
                initAddressAutocomplete('addressInput', 'addressSuggestions');
                window.addressMapInitialized = true;
            }, 100);
        }
    });

    function selectPayment(element, type) {
        // Remove active from all
        document.querySelectorAll('.payment-method').forEach(el => el.classList.remove('active'));
        // Add active to clicked
        element.classList.add('active');
        // Check radio
        element.querySelector('input[type="radio"]').checked = true;
        
        // Show/hide QR section and confirmation
        const qrSection = document.getElementById('qrSection');
        const qrConfirm = document.getElementById('qrPaymentConfirm');
        const submitBtn = document.getElementById('submitBtn');
        
        if (type === 'qr') {
            // PayOS will handle payment - no QR display needed
        }
    }
    
    // Address type toggle
    function selectAddressType(type, element) {
        // Update active class
        document.querySelectorAll('.address-type-option').forEach(el => el.classList.remove('active'));
        element.classList.add('active');
        
        // Update hidden input
        document.getElementById('addressType').value = type;
        
        // Show/hide sections
        const savedDisplay = document.getElementById('savedAddressDisplay');
        const newSection = document.getElementById('newAddressSection');
        const addressInput = document.getElementById('addressInput');
        
        if (type === 'saved') {
            savedDisplay.style.display = 'block';
            newSection.classList.remove('active');
            // Remove required to prevent validation error on hidden field
            addressInput.removeAttribute('required');
            addressInput.value = ''; // clear value
            
            // Geocode saved address to calculate shipping fee
            var savedAddr = document.getElementById('savedAddress');
            if (savedAddr && savedAddr.value) {
                geocodeSavedAddress(savedAddr.value);
            }
        } else {
            savedDisplay.style.display = 'none';
            newSection.classList.add('active');
            addressInput.setAttribute('required', 'required');
            
            // Initialize map if not already
            if (!window.addressMapInitialized) {
                setTimeout(() => {
                    // Default to Bi√™n H√≤a, ƒê·ªìng Nai (near FPT PolySchool)
                    initAddressMap('checkoutMap', 'addressInput', { lat: 10.9452, lng: 106.8274, zoom: 14 });
                    initAddressAutocomplete('addressInput', 'addressSuggestions');
                    window.addressMapInitialized = true;
                }, 100);
            }
        }
    }
    
    // Handle saved address dropdown change
    function onSavedAddressChange(select) {
        var option = select.options[select.selectedIndex];
        var address = option.getAttribute('data-address');
        var phone = option.getAttribute('data-phone');
        var lat = option.getAttribute('data-lat');
        var lng = option.getAttribute('data-lng');
        
        // Update display
        var displayText = document.getElementById('selectedAddressText');
        if (displayText) {
            displayText.textContent = '‚úÖ ' + address;
        }
        
        // Update hidden input
        var savedAddrInput = document.getElementById('savedAddress');
        if (savedAddrInput) {
            savedAddrInput.value = address;
        }
        
        // Update phone if available
        if (phone) {
            var phoneInput = document.querySelector('input[name="phone"]');
            if (phoneInput && !phoneInput.value) {
                phoneInput.value = phone;
            }
        }
        
        // Calculate shipping fee
        if (lat && lng && lat !== 'null' && lng !== 'null') {
            var latVal = parseFloat(lat);
            var lngVal = parseFloat(lng);
            if (!isNaN(latVal) && !isNaN(lngVal) && typeof updateShippingFeeFromCoordinates === 'function') {
                updateShippingFeeFromCoordinates(latVal, lngVal);
                return;
            }
        }
        
        // If no coordinates, geocode the address
        if (address) {
            geocodeSavedAddress(address);
        }
    }
    
    // Geocode saved address and calculate shipping
    function geocodeSavedAddress(address) {
        if (!address) return;
        
        var url = 'https://nominatim.openstreetmap.org/search?format=json&q=' + encodeURIComponent(address) + '&limit=1&accept-language=vi&countrycodes=vn';
        
        fetch(url)
            .then(response => response.json())
            .then(data => {
                if (data && data.length > 0) {
                    var lat = parseFloat(data[0].lat);
                    var lng = parseFloat(data[0].lon);
                    console.log('Saved address geocoded:', lat, lng);
                    
                    // Calculate distance and update shipping fee
                    if (typeof updateShippingFeeFromCoordinates === 'function') {
                        updateShippingFeeFromCoordinates(lat, lng);
                    }
                } else {
                    // Fallback: use default shipping fee (15km estimate for Dong Nai)
                    console.log('Could not geocode saved address, using default');
                    if (typeof calculateShippingFee === 'function') {
                        calculateShippingFee(5); // Default 5km
                    }
                }
            })
            .catch(err => {
                console.log('Geocode error:', err);
                // Fallback
                if (typeof calculateShippingFee === 'function') {
                    calculateShippingFee(5);
                }
            });
    }
    
    // Handle form submit
    const checkoutForm = document.getElementById('checkoutForm');
    if (checkoutForm) {
        checkoutForm.addEventListener('submit', function(e) {
            const addressType = document.getElementById('addressType');
            const phone = document.querySelector('input[name="phone"]');
            
            // Basic validation
            if (!phone.value.trim()) {
                e.preventDefault();
                showToast('Vui l√≤ng nh·∫≠p s·ªë ƒëi·ªán tho·∫°i!', 'error');
                return;
            }

            if (addressType && addressType.value === 'saved') {
                // Case 1: Saved Address
                const savedAddress = document.getElementById('savedAddress').value;
                const addressInput = document.getElementById('addressInput');
                
                // FORCE: populate saved address to the input that controller expects
                if (addressInput) {
                    addressInput.removeAttribute('required'); // Ensure no validation blocks it
                    addressInput.value = savedAddress;
                } else {
                    // Fallback
                    const hidden = document.createElement('input');
                    hidden.type = 'hidden';
                    hidden.name = 'address';
                    hidden.value = savedAddress;
                    this.appendChild(hidden);
                }
            } else {
                // Case 2: New Address
                 const addressInput = document.getElementById('addressInput');
                 if (!addressInput.value.trim()) {
                     e.preventDefault();
                     showToast('Vui l√≤ng nh·∫≠p ƒë·ªãa ch·ªâ giao h√†ng!', 'error');
                     return;
                 }
            }
            // If all good, form submits naturally
        });
    }
    
    // Coupon functionality
    var originalTotal = @totalAmount;
    var currentDiscount = 0;
    
    function applyCoupon() {
        var code = document.getElementById('couponCode').value.trim().toUpperCase();
        var messageDiv = document.getElementById('couponMessage');
        var btn = document.getElementById('applyCouponBtn');
        
        if (!code) {
            messageDiv.innerHTML = '<span style="color: #ef4444;">‚ö†Ô∏è Vui l√≤ng nh·∫≠p m√£ gi·∫£m gi√°!</span>';
            return;
        }
        
        btn.disabled = true;
        btn.innerText = 'ƒêang ki·ªÉm tra...';
        
        fetch('/Order/ValidateCoupon?code=' + encodeURIComponent(code) + '&totalAmount=' + originalTotal)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    currentDiscount = data.discountAmount;
                    document.getElementById('discountAmount').value = currentDiscount;
                    document.getElementById('couponId').value = data.couponId;
                    messageDiv.innerHTML = '<span style="color: #22c55e;">‚úÖ ' + data.message + '</span>';
                    updateOrderSummary();
                } else {
                    messageDiv.innerHTML = '<span style="color: #ef4444;">‚ùå ' + data.message + '</span>';
                    currentDiscount = 0;
                    document.getElementById('discountAmount').value = 0;
                    document.getElementById('couponId').value = '';
                    updateOrderSummary();
                }
            })
            .catch(error => {
                messageDiv.innerHTML = '<span style="color: #ef4444;">‚ö†Ô∏è C√≥ l·ªói x·∫£y ra!</span>';
            })
            .finally(() => {
                btn.disabled = false;
                btn.innerText = '√Åp d·ª•ng';
            });
    }
    
    function updateOrderSummary() {
        var discountDisplay = document.getElementById('discountDisplay');
        var totalDisplay = document.getElementById('totalDisplay');
        var shippingFeeVal = parseFloat(document.getElementById('shippingFee').value) || 0;
        var subtotal = parseFloat(document.getElementById('subtotal').value) || originalTotal;
        
        if (discountDisplay) {
            discountDisplay.innerText = currentDiscount > 0 ? '-' + currentDiscount.toLocaleString('vi-VN') + '‚Ç´' : '-0‚Ç´';
            discountDisplay.style.color = currentDiscount > 0 ? '#22c55e' : 'inherit';
        }
        if (totalDisplay) {
            var finalTotal = subtotal + shippingFeeVal - currentDiscount;
            totalDisplay.innerText = finalTotal.toLocaleString('vi-VN') + '‚Ç´';
        }
    }
    
    // Variable to store current shipping fee
    var currentShippingFee = 0;
    
    // Calculate shipping fee based on distance
    function calculateShippingFee(distance) {
        if (!distance || distance <= 0) {
            document.getElementById('shippingFeeDisplay').innerText = 'Ch·ªçn ƒë·ªãa ch·ªâ ƒë·ªÉ t√≠nh';
            document.getElementById('shippingFeeDisplay').style.color = '#94a3b8';
            document.getElementById('shippingFee').value = 0;
            currentShippingFee = 0;
            updateOrderSummary();
            return;
        }
        
        fetch('/Order/GetShippingFee?distance=' + distance)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    currentShippingFee = data.fee;
                    document.getElementById('shippingFee').value = data.fee;
                    
                    var feeDisplay = document.getElementById('shippingFeeDisplay');
                    if (data.fee == 0) {
                        feeDisplay.innerText = 'Mi·ªÖn ph√≠';
                        feeDisplay.style.color = '#22c55e';
                    } else {
                        feeDisplay.innerText = '+' + data.fee.toLocaleString('vi-VN') + '‚Ç´';
                        feeDisplay.style.color = '#f59e0b';
                    }
                    
                    updateOrderSummary();
                }
            })
            .catch(error => {
                console.error('Error calculating shipping:', error);
            });
    }
    
    // Calculate distance and get shipping fee when address changes
    // This is now handled by address-picker.js when user selects/moves marker
    document.addEventListener('DOMContentLoaded', function() {
        // Check if saved address is selected by default
        var addressType = document.getElementById('addressType');
        var savedAddress = document.getElementById('savedAddress');
        
        if (addressType && addressType.value === 'saved' && savedAddress && savedAddress.value) {
            // Geocode saved address to get shipping fee
            geocodeSavedAddress(savedAddress.value);
        } else {
            // Check if user has coordinates in hidden inputs
            var savedLat = document.querySelector('input[name="latitude"]');
            var savedLng = document.querySelector('input[name="longitude"]');
            if (savedLat && savedLng && savedLat.value && savedLng.value) {
                var lat = parseFloat(savedLat.value);
                var lng = parseFloat(savedLng.value);
                if (!isNaN(lat) && !isNaN(lng) && typeof updateShippingFeeFromCoordinates === 'function') {
                    updateShippingFeeFromCoordinates(lat, lng);
                }
            }
        }
    });
</script>

@section Styles {
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="~/client/css/address-picker.css" />
}

@section Scripts {
    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="~/client/js/address-picker.js"></script>
}