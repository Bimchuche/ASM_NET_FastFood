@model IEnumerable<ASM1_NET.Models.Food>
@using ASM1_NET.Models
@{
    ViewData["Title"] = "Menu";
    var categories = ViewBag.Categories as List<Category> ?? new List<Category>();
    int? currentCategoryId = ViewBag.CategoryId;
    var keyword = ViewBag.Keyword as string ?? "";
    var minPrice = ViewBag.MinPrice as decimal?;
    var maxPrice = ViewBag.MaxPrice as decimal?;
    var minRating = ViewBag.MinRating as int?;
    var sortBy = ViewBag.SortBy as string ?? "";
    var currentPage = (int)(ViewBag.CurrentPage ?? 1);
    var totalPages = (int)(ViewBag.TotalPages ?? 1);
    var totalCount = (int)(ViewBag.TotalCount ?? 0);
    var wishlistIds = ViewBag.WishlistIds as List<int> ?? new List<int>();
}

<link rel="stylesheet" href="~/client/css/menu.css" />
<link rel="stylesheet" href="~/client/css/modal.css" />

<div class="menu-page">
    <div class="container">
        <!-- HERO BANNER -->
        <div class="menu-hero animate-fade-in">
            <div class="menu-hero-content">
                <h1>üçï Th·ª±c ƒë∆°n h·∫•p d·∫´n</h1>
                <p>Kh√°m ph√° c√°c m√≥n ƒÉn ngon nh·∫•t t·ª´ FastFood</p>
            </div>
        </div>

        <div class="menu-layout">
            <!-- FILTER SIDEBAR -->
            <aside class="filter-sidebar">
                <form method="get" asp-action="Index" id="filterForm">
                    <input type="hidden" name="keyword" value="@keyword" />
                    
                    <div class="filter-section">
                        <h4>üìÅ Danh m·ª•c</h4>
                        <div class="filter-options">
                            <label class="filter-option">
                                <input type="radio" name="categoryId" value="" @(currentCategoryId == null ? "checked" : "") onchange="this.form.submit()" />
                                <span>T·∫•t c·∫£</span>
                            </label>
                            @foreach (var cat in categories)
                            {
                                <label class="filter-option">
                                    <input type="radio" name="categoryId" value="@cat.Id" @(currentCategoryId == cat.Id ? "checked" : "") onchange="this.form.submit()" />
                                    <span>@cat.Name</span>
                                </label>
                            }
                        </div>
                    </div>

                    <div class="filter-section">
                        <h4>üí∞ Kho·∫£ng gi√°</h4>
                        <div class="price-inputs">
                            <input type="number" name="minPrice" placeholder="T·ª´" value="@minPrice" />
                            <span>-</span>
                            <input type="number" name="maxPrice" placeholder="ƒê·∫øn" value="@maxPrice" />
                        </div>
                    </div>

                    <div class="filter-section">
                        <h4>‚≠ê ƒê√°nh gi√°</h4>
                        <div class="filter-options">
                            <label class="filter-option">
                                <input type="radio" name="minRating" value="" @(minRating == null ? "checked" : "") />
                                <span>T·∫•t c·∫£</span>
                            </label>
                            @for (int i = 5; i >= 3; i--)
                            {
                                <label class="filter-option">
                                    <input type="radio" name="minRating" value="@i" @(minRating == i ? "checked" : "") />
                                    <span>@(new string('‚≠ê', i)) tr·ªü l√™n</span>
                                </label>
                            }
                        </div>
                    </div>

                    <div class="filter-section">
                        <h4>üîÄ S·∫Øp x·∫øp</h4>
                        <select name="sortBy" onchange="this.form.submit()">
                            <option value="" selected="@(string.IsNullOrEmpty(sortBy))">M·∫∑c ƒë·ªãnh</option>
                            <option value="price_asc" selected="@(sortBy == "price_asc")">Gi√° th·∫•p ‚Üí cao</option>
                            <option value="price_desc" selected="@(sortBy == "price_desc")">Gi√° cao ‚Üí th·∫•p</option>
                            <option value="rating" selected="@(sortBy == "rating")">ƒê√°nh gi√° cao nh·∫•t</option>
                            <option value="newest" selected="@(sortBy == "newest")">M·ªõi nh·∫•t</option>
                            <option value="name_asc" selected="@(sortBy == "name_asc")">A ‚Üí Z</option>
                        </select>
                    </div>

                    <button type="submit" class="btn-apply-filter">üîç √Åp d·ª•ng b·ªô l·ªçc</button>
                    <a href="/Food" class="btn-clear-filter">üóëÔ∏è X√≥a b·ªô l·ªçc</a>
                </form>
            </aside>

            <!-- MAIN CONTENT -->
            <main class="menu-main">
                <!-- SEARCH BAR -->
                <div class="menu-search-container">
                    <form method="get" asp-action="Index" class="menu-search-form">
                        <div class="search-input-wrapper">
                            <span class="search-icon">üîç</span>
                            <input type="text" name="keyword" placeholder="T√¨m m√≥n ƒÉn y√™u th√≠ch..." value="@keyword" />
                            @if (!string.IsNullOrEmpty(keyword))
                            {
                                <a href="/Food@(currentCategoryId.HasValue ? $"?categoryId={currentCategoryId}" : "")" class="clear-search">‚úï</a>
                            }
                        </div>
                        <button type="submit" class="search-btn">T√¨m ki·∫øm</button>
                    </form>
                </div>

                <!-- RESULTS INFO -->
                <div class="results-info">
                    <span>Hi·ªÉn th·ªã <strong>@Model.Count()</strong> / @totalCount m√≥n</span>
                </div>

                <!-- FOOD GRID -->
                <div class="menu-grid">
                    @if (!Model.Any())
                    {
                        <div style="grid-column: 1 / -1;">
                            <div class="menu-empty-state animate-fade-in">
                                <div class="empty-icon">üîç</div>
                                <h3>Kh√¥ng t√¨m th·∫•y m√≥n ƒÉn</h3>
                                <p>H√£y th·ª≠ t√¨m ki·∫øm v·ªõi t·ª´ kh√≥a kh√°c</p>
                                <a href="/Food" class="btn btn-primary btn-lg rounded-pill px-4">Xem t·∫•t c·∫£ m√≥n ƒÉn</a>
                            </div>
                        </div>
                    }
                    else
                    {
                        var delay = 0.0;
                        @foreach (var item in Model)
                        {
                            var isInWishlist = wishlistIds.Contains(item.Id);
                            var avgRating = item.Reviews?.Any() == true ? item.Reviews.Average(r => r.Rating) : 0;
                            
                            <div class="menu-card animate-scale-in" style="animation-delay: @(delay)s;">
                                <!-- Wishlist Button -->
                                <button class="btn-wishlist @(isInWishlist ? "active" : "")" 
                                        onclick="event.stopPropagation(); toggleWishlist(@item.Id, this)" 
                                        title="@(isInWishlist ? "X√≥a kh·ªèi y√™u th√≠ch" : "Th√™m v√†o y√™u th√≠ch")">
                                    @(isInWishlist ? "‚ù§Ô∏è" : "ü§ç")
                                </button>
                                
                                <!-- Badge -->
                                @if (item.Category != null)
                                {
                                    <span class="card-badge">@item.Category.Name</span>
                                }
                                
                                <!-- Image -->
                                <div class="card-image" onclick="openFoodModal(@item.Id)">
                                    <img src="@item.ImageUrl" alt="@item.Name" onerror="this.src='/images/no-image.png'" loading="lazy" />
                                    <div class="card-overlay">
                                        <span class="view-detail">üëÅÔ∏è Xem chi ti·∫øt</span>
                                    </div>
                                </div>
                                
                                <!-- Info -->
                                <div class="card-content">
                                    <h3 class="card-title">@item.Name</h3>
                                    
                                    @if (avgRating > 0)
                                    {
                                        <div class="card-rating">
                                            <span class="stars">@(new string('‚≠ê', (int)Math.Round(avgRating)))</span>
                                            <span class="rating-value">@avgRating.ToString("0.0")</span>
                                            <span class="review-count">(@item.Reviews!.Count)</span>
                                        </div>
                                    }
                                    
                                    <p class="card-description">@(item.Description?.Length > 50 ? item.Description.Substring(0, 50) + "..." : item.Description)</p>
                                    
                                    <div class="card-footer">
                                        <div class="card-price">
                                            <span class="price-value">@item.Price.ToString("N0")</span>
                                            <span class="price-unit">‚Ç´</span>
                                        </div>
                                        <button class="card-add-btn" onclick="event.stopPropagation(); addToCart(@item.Id)">
                                            <span>üõí</span> Th√™m
                                        </button>
                                    </div>
                                </div>
                            </div>
                            delay += 0.05;
                            if (delay > 0.3) delay = 0;
                        }
                    }
                </div>

                <!-- PAGINATION -->
                @if (totalPages > 1)
                {
                    <div class="pagination">
                        @if (currentPage > 1)
                        {
                            <a href="@BuildPageUrl(currentPage - 1)" class="page-btn">¬´ Tr∆∞·ªõc</a>
                        }
                        
                        @for (int i = 1; i <= totalPages; i++)
                        {
                            if (i == 1 || i == totalPages || (i >= currentPage - 2 && i <= currentPage + 2))
                            {
                                <a href="@BuildPageUrl(i)" class="page-btn @(i == currentPage ? "active" : "")">@i</a>
                            }
                            else if (i == currentPage - 3 || i == currentPage + 3)
                            {
                                <span class="page-dots">...</span>
                            }
                        }
                        
                        @if (currentPage < totalPages)
                        {
                            <a href="@BuildPageUrl(currentPage + 1)" class="page-btn">Sau ¬ª</a>
                        }
                    </div>
                }
            </main>
        </div>
    </div>
</div>

<!-- FOOD MODAL -->
<div id="foodModal" class="modal-overlay" style="display:none;">
    <div class="modal-content">
        <span class="modal-close" onclick="closeFoodModal()">√ó</span>
        <div id="foodModalBody"></div>
    </div>
</div>

@functions {
    string BuildPageUrl(int page)
    {
        var query = new List<string> { $"page={page}" };
        if (ViewBag.CategoryId != null) query.Add($"categoryId={ViewBag.CategoryId}");
        if (!string.IsNullOrEmpty(ViewBag.Keyword as string)) query.Add($"keyword={ViewBag.Keyword}");
        if (ViewBag.MinPrice != null) query.Add($"minPrice={ViewBag.MinPrice}");
        if (ViewBag.MaxPrice != null) query.Add($"maxPrice={ViewBag.MaxPrice}");
        if (ViewBag.MinRating != null) query.Add($"minRating={ViewBag.MinRating}");
        if (!string.IsNullOrEmpty(ViewBag.SortBy as string)) query.Add($"sortBy={ViewBag.SortBy}");
        return "/Food?" + string.Join("&", query);
    }
}

<script src="~/client/js/food-page.js"></script>