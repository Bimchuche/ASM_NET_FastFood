@model ASM1_NET.ViewModels.CreateComboViewModel
@{
    ViewData["Title"] = "S·ª≠a Combo";
    var comboId = ViewBag.ComboId;
    var existingImage = ViewBag.ExistingImageUrl as string;
}

@section Styles {
    <link rel="stylesheet" href="~/admin/css/combo.css" />
}

<div class="admin-header">
    <h1 class="admin-title">‚úèÔ∏è S·ª≠a Combo</h1>
    <a asp-action="Index" class="btn-admin">‚Üê Quay l·∫°i</a>
</div>

@if (TempData["Error"] != null)
{
    <div class="admin-alert danger">‚ö†Ô∏è @TempData["Error"]</div>
}
@if (TempData["Success"] != null)
{
    <div class="admin-alert success">‚úÖ @TempData["Success"]</div>
}

<form method="post" asp-route-id="@comboId" enctype="multipart/form-data" id="editComboForm">
    @Html.AntiForgeryToken()

    <div class="row">
        <!-- LEFT: COMBO INFO -->
        <div class="col-md-4">
            <div class="admin-form-card">
                <div class="form-card-header">
                    <h4>üéÅ Th√¥ng tin Combo</h4>
                </div>
                <div class="form-card-body">
                    <div class="form-group">
                        <label class="form-label">T√™n Combo *</label>
                        <input asp-for="Name" id="comboNameInput" class="form-control" required placeholder="V√≠ d·ª•: Combo Tr∆∞a Vui V·∫ª" />
                        <button type="button" class="btn-admin" style="margin-top: 8px; font-size: 12px;" onclick="autoGenerateName()">
                            ‚ú® T·ª± ƒë·ªông ƒë·∫∑t t√™n
                        </button>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Gi√° Combo (VNƒê) *</label>
                        <input asp-for="Price" type="number" class="form-control" required min="0" step="1000" id="comboPriceInput" />
                        <small class="text-muted">Nh·∫•n "G·ª£i √Ω gi√°" ƒë·ªÉ t·ª± t√≠nh v·ªõi ∆∞u ƒë√£i 10%</small>
                    </div>

                    <div class="form-group">
                        <label class="form-label">M√¥ t·∫£</label>
                        <textarea asp-for="Description" id="descriptionInput" class="form-control" rows="3" placeholder="M√¥ t·∫£ combo..."></textarea>
                        <button type="button" class="btn-admin" style="margin-top: 8px; font-size: 12px;" onclick="autoGenerateDescription()">
                            üìù T·ª± ƒë·ªông ghi m√¥ t·∫£
                        </button>
                    </div>

                    <div class="form-group">
                        <label class="form-label">·∫¢nh Combo</label>
                        @if (!string.IsNullOrEmpty(existingImage))
                        {
                            <div class="existing-image-box">
                                <img src="@existingImage" alt="·∫¢nh combo hi·ªán t·∫°i" />
                                <p class="text-muted" style="font-size: 12px; margin-top: 5px;">·∫¢nh hi·ªán t·∫°i</p>
                            </div>
                        }
                        <input asp-for="ImageFile" type="file" class="form-control" accept="image/*" onchange="previewImg(this)" />
                        <div id="imgPreview" class="img-preview-box"></div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Tr·∫°ng th√°i</label>
                        <select asp-for="IsActive" class="form-select">
                            <option value="true">‚úÖ ƒêang b√°n</option>
                            <option value="false">üö´ Ng·ª´ng b√°n</option>
                        </select>
                    </div>
                </div>
            </div>
            
            <!-- PRICE SUMMARY -->
            <div class="price-summary-card">
                <h5>üí∞ T·ªïng gi√° tr·ªã g·ªëc</h5>
                <div id="originalTotal" class="total-value">0‚Ç´</div>
                <button type="button" class="btn-admin primary" style="margin-top: 15px;" onclick="suggestPrice()">
                    ‚ú® G·ª£i √Ω gi√° (Gi·∫£m 10%)
                </button>
            </div>
        </div>

        <!-- RIGHT: SELECT FOODS & DRINKS -->
        <div class="col-md-8">
            <!-- SECTION: FOODS -->
            <div class="admin-form-card">
                <div class="form-card-header section-header-food d-flex justify-content-between align-items-center">
                    <h4>üçî Ch·ªçn M√≥n ƒÇn</h4>
                    <span class="badge-admin primary" id="foodCount">0 m√≥n</span>
                </div>
                <div class="form-card-body food-list-scroll">
                    <div class="row">
                        @for (int i = 0; i < Model.FoodList.Count; i++)
                        {
                            <div class="col-md-6 mb-3">
                                <div class="food-select-card @(Model.FoodList[i].IsSelected ? "selected" : "")" onclick="toggleCard(this)">
                                    <input type="hidden" asp-for="FoodList[i].Id" />
                                    <input type="hidden" asp-for="FoodList[i].Name" />
                                    <input type="hidden" asp-for="FoodList[i].Price" />
                                    <input type="checkbox" asp-for="FoodList[i].IsSelected" class="food-checkbox" data-price="@Model.FoodList[i].Price" onchange="updateTotals()" />
                                    
                                    <div class="d-flex gap-3 align-items-center">
                                        @if (!string.IsNullOrEmpty(Model.FoodList[i].ImageUrl))
                                        {
                                            <img src="@Model.FoodList[i].ImageUrl" class="food-thumb" />
                                        }
                                        else
                                        {
                                            <div class="food-thumb-placeholder">üçΩÔ∏è</div>
                                        }
                                        <div class="flex-grow-1">
                                            <strong>@Model.FoodList[i].Name</strong>
                                            <div class="text-muted" style="font-size: 12px;">@Model.FoodList[i].CategoryName</div>
                                            <div class="text-success fw-bold">@Model.FoodList[i].Price.ToString("N0")‚Ç´</div>
                                        </div>
                                    </div>
                                    
                                    <div class="qty-row" onclick="event.stopPropagation()">
                                        <span>SL:</span>
                                        <input asp-for="FoodList[i].Quantity" type="number" min="1" class="qty-input" onchange="updateTotals()" />
                                    </div>
                                </div>
                            </div>
                        }
                    </div>
                </div>
            </div>

            <!-- SECTION: DRINKS -->
            <div class="admin-form-card" style="margin-top: 20px;">
                <div class="form-card-header section-header-drink d-flex justify-content-between align-items-center">
                    <h4>ü•§ Ch·ªçn Th·ª©c U·ªëng</h4>
                    <span class="badge-admin success" id="drinkCount">0 m√≥n</span>
                </div>
                <div class="form-card-body food-list-scroll" style="max-height: 300px;">
                    <div class="row">
                        @for (int i = 0; i < Model.DrinkList.Count; i++)
                        {
                            <div class="col-md-6 mb-3">
                                <div class="food-select-card @(Model.DrinkList[i].IsSelected ? "selected" : "")" onclick="toggleCard(this)">
                                    <input type="hidden" asp-for="DrinkList[i].Id" />
                                    <input type="hidden" asp-for="DrinkList[i].Name" />
                                    <input type="hidden" asp-for="DrinkList[i].Price" />
                                    <input type="checkbox" asp-for="DrinkList[i].IsSelected" class="food-checkbox" data-price="@Model.DrinkList[i].Price" onchange="updateTotals()" />
                                    
                                    <div class="d-flex gap-3 align-items-center">
                                        @if (!string.IsNullOrEmpty(Model.DrinkList[i].ImageUrl))
                                        {
                                            <img src="@Model.DrinkList[i].ImageUrl" class="food-thumb" />
                                        }
                                        else
                                        {
                                            <div class="food-thumb-placeholder">ü•§</div>
                                        }
                                        <div class="flex-grow-1">
                                            <strong>@Model.DrinkList[i].Name</strong>
                                            <div class="text-success fw-bold">@Model.DrinkList[i].Price.ToString("N0")‚Ç´</div>
                                        </div>
                                    </div>
                                    
                                    <div class="qty-row" onclick="event.stopPropagation()">
                                        <span>SL:</span>
                                        <input asp-for="DrinkList[i].Quantity" type="number" min="1" class="qty-input" onchange="updateTotals()" />
                                    </div>
                                </div>
                            </div>
                        }
                    </div>
                </div>
            </div>

            <!-- SUBMIT -->
            <div class="combo-form-actions">
                <button type="submit" class="btn-admin primary" style="padding: 12px 40px;">
                    üíæ C·∫≠p nh·∫≠t Combo
                </button>
                <a asp-action="Index" class="btn-admin">‚ùå H·ªßy</a>
            </div>
        </div>
    </div>
</form>

@section Scripts {
    <script>
        function toggleCard(card) {
            var checkbox = card.querySelector('input[type="checkbox"]');
            checkbox.checked = !checkbox.checked;
            card.classList.toggle('selected', checkbox.checked);
            updateTotals();
        }

        function updateTotals() {
            var total = 0;
            var foodCount = 0;
            var drinkCount = 0;
            
            document.querySelectorAll('.admin-form-card').forEach(section => {
                var header = section.querySelector('.form-card-header h4')?.textContent || '';
                section.querySelectorAll('.food-select-card').forEach(card => {
                    var cb = card.querySelector('input[type="checkbox"]');
                    var qty = card.querySelector('.qty-input');
                    
                    card.classList.toggle('selected', cb.checked);
                    
                    if (cb.checked) {
                        var price = parseFloat(cb.dataset.price) || 0;
                        var q = parseInt(qty.value) || 1;
                        total += price * q;
                        
                        if (header.includes('Th·ª©c U·ªëng')) drinkCount++;
                        else if (header.includes('M√≥n ƒÇn')) foodCount++;
                    }
                });
            });
            
            document.getElementById('originalTotal').innerText = total.toLocaleString('vi-VN') + '‚Ç´';
            document.getElementById('originalTotal').dataset.raw = total;
            document.getElementById('foodCount').innerText = foodCount + ' m√≥n';
            document.getElementById('drinkCount').innerText = drinkCount + ' m√≥n';
        }

        function suggestPrice() {
            var raw = parseFloat(document.getElementById('originalTotal').dataset.raw) || 0;
            if (raw > 0) {
                var discounted = Math.round((raw * 0.9) / 1000) * 1000;
                var input = document.getElementById('comboPriceInput');
                input.value = discounted;
                input.classList.add('price-flash');
                setTimeout(() => input.classList.remove('price-flash'), 500);
            }
        }

        function previewImg(input) {
            var preview = document.getElementById('imgPreview');
            if (input.files && input.files[0]) {
                var reader = new FileReader();
                reader.onload = e => preview.innerHTML = '<img src="' + e.target.result + '">';
                reader.readAsDataURL(input.files[0]);
            }
        }

        function autoGenerateDescription() {
            var foods = [];
            var drinks = [];
            
            document.querySelectorAll('.admin-form-card').forEach(section => {
                var header = section.querySelector('.form-card-header h4')?.textContent || '';
                section.querySelectorAll('.food-select-card').forEach(card => {
                    var cb = card.querySelector('input[type="checkbox"]');
                    if (cb.checked) {
                        var qty = parseInt(card.querySelector('.qty-input').value) || 1;
                        var nameInput = card.querySelector('input[name*=".Name"]');
                        var name = nameInput ? nameInput.value : card.querySelector('strong')?.textContent || '';
                        
                        var itemText = qty > 1 ? qty + ' ' + name : name;
                        
                        if (header.includes('Th·ª©c U·ªëng')) {
                            drinks.push(itemText);
                        } else if (header.includes('M√≥n ƒÇn')) {
                            foods.push(itemText);
                        }
                    }
                });
            });
            
            var desc = '';
            if (foods.length > 0) {
                desc += 'Bao g·ªìm: ' + foods.join(', ');
            }
            if (drinks.length > 0) {
                if (desc) desc += '. ';
                desc += 'K√®m th·ª©c u·ªëng: ' + drinks.join(', ');
            }
            if (desc) {
                desc += '. Ti·∫øt ki·ªám h∆°n khi mua combo!';
            }
            
            document.getElementById('descriptionInput').value = desc;
            document.getElementById('descriptionInput').style.background = '#dcfce7';
            setTimeout(() => document.getElementById('descriptionInput').style.background = '', 500);
        }

        function autoGenerateName() {
            var foods = [];
            
            document.querySelectorAll('.admin-form-card').forEach(section => {
                var header = section.querySelector('.form-card-header h4')?.textContent || '';
                if (header.includes('M√≥n ƒÇn')) {
                    section.querySelectorAll('.food-select-card').forEach(card => {
                        var cb = card.querySelector('input[type="checkbox"]');
                        if (cb.checked) {
                            var nameInput = card.querySelector('input[name*=".Name"]');
                            var name = nameInput ? nameInput.value : card.querySelector('strong')?.textContent || '';
                            foods.push(name.split(' ')[0]);
                        }
                    });
                }
            });
            
            var comboName = 'Combo ';
            if (foods.length > 0) {
                comboName += foods.slice(0, 3).join(' + ');
                if (foods.length > 3) {
                    comboName += '...';
                }
            } else {
                comboName += 'ƒê·∫∑c Bi·ªát';
            }
            
            document.getElementById('comboNameInput').value = comboName;
            document.getElementById('comboNameInput').style.background = '#dcfce7';
            setTimeout(() => document.getElementById('comboNameInput').style.background = '', 500);
        }

        document.addEventListener('DOMContentLoaded', updateTotals);
    </script>
}