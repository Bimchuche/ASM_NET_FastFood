@model ASM1_NET.Models.ChatSession
@using System.Security.Claims
@{
    ViewData["Title"] = "Chat v·ªõi " + (Model.Customer?.FullName ?? "Kh√°ch");
    Layout = "~/Areas/Admin/Views/Shared/_AdminLayout.cshtml";
    var adminIdClaim = User.FindFirst(ClaimTypes.NameIdentifier)?.Value;
    var adminId = !string.IsNullOrEmpty(adminIdClaim) ? int.Parse(adminIdClaim) : (Context.Session.GetInt32("UserId") ?? 0);
    var isOpen = Model.Status == "Open";
    var customerInitial = Model.Customer?.FullName?.Substring(0, 1).ToUpper() ?? "K";
}

<link rel="stylesheet" href="~/admin/css/chat-session.css" />

<div class="chat-session-container">
    <!-- Sidebar: Customer Info -->
    <div class="chat-sidebar">
        <div class="sidebar-header">
            <a href="/Admin/Chat" class="back-link">
                <span>‚Üê</span>
                <span>Quay l·∫°i</span>
            </a>
        </div>
        
        <div class="customer-profile">
            <div class="customer-avatar" style="background: linear-gradient(135deg, @(isOpen ? "#10b981, #059669" : "#6b7280, #4b5563"));">
                <span>@customerInitial</span>
            </div>
            <h3>@(Model.Customer?.FullName ?? "Kh√°ch h√†ng")</h3>
            <span class="status-badge @(isOpen ? "open" : "closed")">
                @(isOpen ? "‚óè ƒêang chat" : "‚óã ƒê√£ ƒë√≥ng")
            </span>
        </div>
        
        <div class="customer-details">
            <div class="detail-item">
                <span class="detail-icon">üìß</span>
                <div class="detail-content">
                    <span class="detail-label">Email</span>
                    <span class="detail-value">@(Model.Customer?.Email ?? "Kh√¥ng c√≥")</span>
                </div>
            </div>
            <div class="detail-item">
                <span class="detail-icon">üì±</span>
                <div class="detail-content">
                    <span class="detail-label">ƒêi·ªán tho·∫°i</span>
                    <span class="detail-value">@(Model.Customer?.Phone ?? "Kh√¥ng c√≥")</span>
                </div>
            </div>
            <div class="detail-item">
                <span class="detail-icon">üïê</span>
                <div class="detail-content">
                    <span class="detail-label">B·∫Øt ƒë·∫ßu chat</span>
                    <span class="detail-value">@Model.CreatedAt.ToString("dd/MM/yyyy HH:mm")</span>
                </div>
            </div>
            <div class="detail-item">
                <span class="detail-icon">üí¨</span>
                <div class="detail-content">
                    <span class="detail-label">S·ªë tin nh·∫Øn</span>
                    <span class="detail-value">@Model.Messages.Count tin nh·∫Øn</span>
                </div>
            </div>
        </div>
        
        @if (isOpen)
        {
            <div class="sidebar-actions">
                <form method="post" action="/Admin/Chat/CloseSession/@Model.Id">
                    @Html.AntiForgeryToken()
                    <button type="submit" class="close-session-btn" onclick="return confirm('ƒê√≥ng cu·ªôc tr√≤ chuy·ªán n√†y?')">
                        <span>‚úï</span>
                        <span>ƒê√≥ng cu·ªôc tr√≤ chuy·ªán</span>
                    </button>
                </form>
            </div>
        }
    </div>

    <!-- Main Chat Area -->
    <div class="chat-main">
        <div class="chat-main-header">
            <div class="header-info">
                <h2>üí¨ Cu·ªôc tr√≤ chuy·ªán</h2>
                <span>v·ªõi @(Model.Customer?.FullName ?? "Kh√°ch h√†ng")</span>
            </div>
            <div class="header-badge">
                @if (isOpen)
                {
                    <span class="live-indicator">
                        <span class="pulse"></span>
                        Realtime
                    </span>
                }
            </div>
        </div>
        
        <div class="chat-messages-container" id="messagesArea">
            @if (!Model.Messages.Any())
            {
                <div class="no-messages">
                    <div class="no-msg-icon">üí¨</div>
                    <p>Cu·ªôc tr√≤ chuy·ªán m·ªõi b·∫Øt ƒë·∫ßu.<br>Ch∆∞a c√≥ tin nh·∫Øn n√†o.</p>
                </div>
            }
            else
            {
                @foreach (var msg in Model.Messages)
                {
                    var isCustomer = msg.IsFromCustomer;
                    <div class="message-wrapper @(isCustomer ? "customer" : "admin")">
                        @if (isCustomer)
                        {
                            <div class="msg-avatar customer-avatar-small">
                                @customerInitial
                            </div>
                        }
                        <div class="message-bubble">
                            <div class="msg-text">@msg.Message</div>
                            <div class="msg-info">
                                <span class="msg-sender">@(msg.Sender?.FullName ?? (isCustomer ? "Kh√°ch" : "H·ªó tr·ª£"))</span>
                                <span class="msg-time">@msg.CreatedAt.ToString("HH:mm")</span>
                            </div>
                        </div>
                        @if (!isCustomer)
                        {
                            <div class="msg-avatar admin-avatar-small">
                                üéß
                            </div>
                        }
                    </div>
                }
            }
        </div>
        
        @if (isOpen)
        {
            <div class="chat-input-container">
                <div class="input-wrapper">
                    <input type="text" id="adminMessageInput" placeholder="G√µ tin nh·∫Øn ƒë·ªÉ tr·∫£ l·ªùi kh√°ch h√†ng..." maxlength="1000">
                    <button id="sendAdminMessage" class="send-btn">
                        <span>‚û§</span>
                    </button>
                </div>
                <div class="input-hint">
                    Nh·∫•n <kbd>Enter</kbd> ƒë·ªÉ g·ª≠i
                </div>
            </div>
        }
        else
        {
            <div class="chat-closed-banner">
                <div class="closed-icon">üîí</div>
                <div class="closed-text">
                    <strong>Cu·ªôc tr√≤ chuy·ªán ƒë√£ k·∫øt th√∫c</strong>
                    <span>ƒê√≥ng l√∫c @(Model.ClosedAt?.ToString("dd/MM/yyyy HH:mm"))</span>
                </div>
            </div>
        }
</div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/8.0.0/signalr.min.js"></script>
<script>
    // Razor variables required by chat-session.js
    const sessionId = @Model.Id;
    const adminId = @adminId;
    const customerInitial = '@customerInitial';
</script>
<script src="~/admin/js/chat-session.js"></script>

