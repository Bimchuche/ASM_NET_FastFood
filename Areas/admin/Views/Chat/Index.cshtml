@model List<ASM1_NET.Models.ChatSession>
@{
    ViewData["Title"] = "Qu·∫£n l√Ω Chat";
    Layout = "~/Areas/Admin/Views/Shared/_AdminLayout.cshtml";
}

<div class="chat-admin-container">
    <!-- Header -->
    <div class="chat-admin-header">
        <div class="header-left">
            <div class="header-icon">
                <span>üí¨</span>
            </div>
            <div class="header-text">
                <h1>Chat H·ªó tr·ª£ Kh√°ch h√†ng</h1>
                <p>Qu·∫£n l√Ω v√† tr·∫£ l·ªùi tin nh·∫Øn t·ª´ kh√°ch h√†ng</p>
            </div>
        </div>
        <div class="header-stats">
            <div class="stat-item open">
                <span class="stat-value">@Model.Count(s => s.Status == "Open")</span>
                <span class="stat-label">ƒêang m·ªü</span>
            </div>
            <div class="stat-item total">
                <span class="stat-value">@Model.Count</span>
                <span class="stat-label">T·ªïng c·ªông</span>
            </div>
        </div>
    </div>

    @if (TempData["Success"] != null)
    {
        <div class="toast-message success">
            <span class="toast-icon">‚úÖ</span>
            <span>@TempData["Success"]</span>
        </div>
    }
    @if (TempData["Error"] != null)
    {
        <div class="toast-message error">
            <span class="toast-icon">‚ö†Ô∏è</span>
            <span>@TempData["Error"]</span>
        </div>
    }

    <!-- Chat List -->
    <div class="chat-list-wrapper">
        @if (!Model.Any())
        {
            <div class="empty-chat-state">
                <div class="empty-illustration">
                    <div class="bubble bubble-1">üí¨</div>
                    <div class="bubble bubble-2">üéß</div>
                    <div class="bubble bubble-3">‚ú®</div>
                </div>
                <h3>Ch∆∞a c√≥ cu·ªôc tr√≤ chuy·ªán n√†o</h3>
                <p>Khi kh√°ch h√†ng g·ª≠i tin nh·∫Øn h·ªó tr·ª£,<br>cu·ªôc tr√≤ chuy·ªán s·∫Ω xu·∫•t hi·ªán ·ªü ƒë√¢y</p>
            </div>
        }
        else
        {
            <div class="chat-list">
                @foreach (var session in Model)
                {
                    var unreadCount = session.Messages.Count(m => m.IsFromCustomer && !m.IsRead);
                    var lastMessage = session.Messages.OrderByDescending(m => m.CreatedAt).FirstOrDefault();
                    var isOpen = session.Status == "Open";
                    var customerInitial = session.Customer?.FullName?.Substring(0, 1).ToUpper() ?? "K";
                    
                    <div class="chat-item @(isOpen ? "open" : "closed") @(unreadCount > 0 ? "has-unread" : "")">
                        <div class="chat-item-avatar" style="background: linear-gradient(135deg, @(isOpen ? "#10b981, #059669" : "#6b7280, #4b5563"));">
                            <span>@customerInitial</span>
                            @if (isOpen)
                            {
                                <div class="status-dot"></div>
                            }
                        </div>
                        
                        <div class="chat-item-content">
                            <div class="chat-item-header">
                                <h4>@(session.Customer?.FullName ?? "Kh√°ch h√†ng")</h4>
                                @if (unreadCount > 0)
                                {
                                    <span class="unread-count">@unreadCount</span>
                                }
                            </div>
                            
                            <div class="chat-item-preview">
                                @if (lastMessage != null)
                                {
                                    <span class="preview-sender">@(lastMessage.IsFromCustomer ? "" : "B·∫°n: ")</span>
                                    <span class="preview-text">@(lastMessage.Message.Length > 40 ? lastMessage.Message.Substring(0, 40) + "..." : lastMessage.Message)</span>
                                }
                                else
                                {
                                    <span class="preview-empty">Ch∆∞a c√≥ tin nh·∫Øn</span>
                                }
                            </div>
                            
                            <div class="chat-item-meta">
                                <span class="meta-time">
                                    <i>üïê</i> @(lastMessage?.CreatedAt.ToString("dd/MM HH:mm") ?? session.CreatedAt.ToString("dd/MM HH:mm"))
                                </span>
                                <span class="meta-status @(isOpen ? "open" : "closed")">
                                    @(isOpen ? "‚óè ƒêang m·ªü" : "‚óã ƒê√£ ƒë√≥ng")
                                </span>
                            </div>
                        </div>
                        
                        <div class="chat-item-actions">
                            <a href="/Admin/Chat/Session/@session.Id" class="action-btn primary" title="Xem chat">
                                <span>üí¨</span>
                                <span>Xem</span>
                            </a>
                            @if (isOpen)
                            {
                                <form method="post" action="/Admin/Chat/CloseSession/@session.Id" class="inline-form">
                                    @Html.AntiForgeryToken()
                                    <button type="submit" class="action-btn secondary" title="ƒê√≥ng chat" onclick="return confirm('ƒê√≥ng cu·ªôc tr√≤ chuy·ªán n√†y?')">
                                        <span>‚úï</span>
                                    </button>
                                </form>
                            }
                        </div>
                    </div>
                }
            </div>
        }
    </div>
</div>

<link rel="stylesheet" href="~/admin/css/chat-index.css" />

