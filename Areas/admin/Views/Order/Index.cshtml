@model IEnumerable<ASM1_NET.Models.Order>

@{
    ViewData["Title"] = "Quáº£n lÃ½ Ä‘Æ¡n hÃ ng";
    var pendingCount = Model.Count(o => o.Status == "Pending");
    var deliveringCount = Model.Count(o => o.Status == "Delivering");
    var completedCount = Model.Count(o => o.Status == "Completed");
    var refundPendingCount = Model.Count(o => o.PaymentStatus == "RefundPending");
    var totalRevenue = Model.Where(o => o.Status == "Completed").Sum(o => o.TotalAmount);
}

<!-- ALERTS -->
@if (TempData["Success"] != null)
{
    <div class="admin-alert success">âœ… @TempData["Success"]</div>
}
@if (TempData["Error"] != null)
{
    <div class="admin-alert danger">âš ï¸ @TempData["Error"]</div>
}

<!-- Hidden form for bulk delete -->
<form id="bulkDeleteForm" asp-action="BulkDelete" method="post" style="display:none;">
    @Html.AntiForgeryToken()
    <div id="deleteIds"></div>
</form>

<!-- STATS -->
<div class="stats-grid">
    <div class="stat-card">
        <div class="stat-icon warning">â³</div>
        <div class="stat-info">
            <h3>@pendingCount</h3>
            <p>ÄÆ¡n chá» xá»­ lÃ½</p>
        </div>
    </div>
    <div class="stat-card">
        <div class="stat-icon primary">ğŸšš</div>
        <div class="stat-info">
            <h3>@deliveringCount</h3>
            <p>Äang giao</p>
        </div>
    </div>
    <div class="stat-card">
        <div class="stat-icon success">âœ…</div>
        <div class="stat-info">
            <h3>@completedCount</h3>
            <p>HoÃ n thÃ nh</p>
        </div>
    </div>
    @if (refundPendingCount > 0)
    {
        <div class="stat-card" style="border: 2px solid #f59e0b;">
            <div class="stat-icon" style="background: linear-gradient(135deg, #f59e0b, #d97706);">ğŸ’¸</div>
            <div class="stat-info">
                <h3 style="color: #f59e0b;">@refundPendingCount</h3>
                <p>Chá» hoÃ n tiá»n</p>
            </div>
        </div>
    }
    <div class="stat-card">
        <div class="stat-icon danger">ğŸ’°</div>
        <div class="stat-info">
            <h3>@totalRevenue.ToString("N0") â‚«</h3>
            <p>Doanh thu</p>
        </div>
    </div>
</div>

<!-- HEADER -->
<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h2 class="mb-1">ğŸ“¦ Quáº£n lÃ½ Ä‘Æ¡n hÃ ng</h2>
        <p class="text-muted mb-0">Tá»•ng: <strong>@Model.Count()</strong> Ä‘Æ¡n</p>
    </div>
    <div class="d-flex gap-2">
        <button type="button" class="btn-admin danger" onclick="submitBulkDelete()">
            ğŸ—‘ï¸ XÃ³a Ä‘Ã£ chá»n (<span id="selectedCount">0</span>)
        </button>
    </div>
</div>

<!-- TABLE CARD -->
<div class="admin-table-card">
    <div class="table-header">
        <h3>ğŸ“‹ Danh sÃ¡ch Ä‘Æ¡n hÃ ng</h3>
        <div class="table-search">
            <select id="filterStatus" onchange="filterByStatus()" class="form-select form-select-sm" style="width: auto;">
                <option value="">Táº¥t cáº£</option>
                <optgroup label="Tráº¡ng thÃ¡i Ä‘Æ¡n hÃ ng">
                    <option value="status:Pending">â³ Chá» xá»­ lÃ½</option>
                    <option value="status:Äang xá»­ lÃ½">ğŸ”„ Äang xá»­ lÃ½</option>
                    <option value="status:Delivering">ğŸšš Äang giao</option>
                    <option value="status:Completed">âœ… HoÃ n thÃ nh</option>
                    <option value="status:Cancelled">âŒ ÄÃ£ há»§y</option>
                </optgroup>
                <optgroup label="Tráº¡ng thÃ¡i thanh toÃ¡n">
                    <option value="payment:Paid">ğŸ’³ ÄÃ£ thanh toÃ¡n (QR)</option>
                    <option value="payment:RefundPending">ğŸ’¸ Chá» hoÃ n tiá»n</option>
                    <option value="payment:Refunded">âœ… ÄÃ£ hoÃ n tiá»n</option>
                </optgroup>
            </select>
            <input type="text" id="searchOrder" placeholder="TÃ¬m kiáº¿m..." onkeyup="filterTable()" />
        </div>
    </div>
    
    <table class="admin-table" id="orderTable">
        <thead>
            <tr>
                <th style="width: 40px;"><input type="checkbox" id="selectAll" onclick="toggleAll(this)"></th>
                <th>MÃ£ Ä‘Æ¡n</th>
                <th>KhÃ¡ch hÃ ng</th>
                <th>NgÃ y Ä‘áº·t</th>
                <th>Tá»•ng tiá»n</th>
                <th>Tráº¡ng thÃ¡i</th>
                <th>Shipper</th>
                <th style="width: 180px;">HÃ nh Ä‘á»™ng</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var o in Model.OrderByDescending(o => o.OrderDate))
            {
                var statusClass = o.Status switch
                {
                    "Pending" => "warning",
                    "ÄÃ£ thanh toÃ¡n" => "primary",
                    "Äang xá»­ lÃ½" => "info",
                    "Delivering" => "info",
                    "Completed" => "success",
                    "Cancelled" => "danger",
                    _ => "info"
                };
                var statusIcon = o.Status switch
                {
                    "Pending" => "â³",
                    "ÄÃ£ thanh toÃ¡n" => "ğŸ’³",
                    "Äang xá»­ lÃ½" => "ğŸ”„",
                    "Delivering" => "ğŸšš",
                    "Completed" => "âœ…",
                    "Cancelled" => "âŒ",
                    _ => "ğŸ“¦"
                };
                var statusText = o.Status switch
                {
                    "Pending" => "Chá» xá»­ lÃ½",
                    "ÄÃ£ thanh toÃ¡n" => "ÄÃ£ thanh toÃ¡n",
                    "Äang xá»­ lÃ½" => "Äang xá»­ lÃ½",
                    "Delivering" => "Äang giao",
                    "Completed" => "HoÃ n thÃ nh",
                    "Cancelled" => "ÄÃ£ há»§y",
                    _ => o.Status
                };
                
                <tr data-status="@o.Status" data-payment="@o.PaymentStatus">
                    <td><input type="checkbox" class="item-checkbox" data-id="@o.Id" onclick="updateCount()"></td>
                    <td>
                        <strong class="text-primary">#@o.OrderCode</strong>
                    </td>
                    <td>
                        <strong>@(o.Customer?.FullName ?? "N/A")</strong>
                        <br /><small class="text-muted">ğŸ“ @o.Phone</small>
                    </td>
                    <td>
                        <span>@o.OrderDate.ToString("dd/MM/yyyy")</span>
                        <br /><small class="text-muted">@o.OrderDate.ToString("HH:mm")</small>
                    </td>
                    <td>
                        <strong class="text-success">@o.TotalAmount.ToString("N0") â‚«</strong>
                    </td>
                    <td>
                        <span class="badge-admin @statusClass">@statusIcon @statusText</span>
                        @if (o.PaymentStatus == "RefundPending")
                        {
                            <br /><span style="color: #f59e0b; font-size: 0.75rem;">ğŸ’¸ Chá» hoÃ n tiá»n</span>
                        }
                        else if (o.PaymentStatus == "Refunded")
                        {
                            <br /><span style="color: #10b981; font-size: 0.75rem;">âœ… ÄÃ£ hoÃ n tiá»n</span>
                        }
                    </td>
                    <td>
                        @if (o.Shipper != null)
                        {
                            <span class="badge-admin info">ğŸš´ @o.Shipper.FullName</span>
                        }
                        else
                        {
                            <span class="text-muted">ChÆ°a cÃ³</span>
                        }
                    </td>
                    <td>
                        <div class="action-btns">
                            <a asp-action="Detail" asp-route-id="@o.Id" class="action-btn view" title="Xem chi tiáº¿t">
                                ğŸ‘ï¸
                            </a>
                            <a asp-action="Edit" asp-route-id="@o.Id" class="action-btn edit" title="Sá»­a">
                                âœï¸
                            </a>
                            @if (o.PaymentStatus == "RefundPending")
                            {
                                <form asp-action="ConfirmRefund" method="post" style="display: inline;">
                                    @Html.AntiForgeryToken()
                                    <input type="hidden" name="id" value="@o.Id" />
                                    <button type="submit" class="action-btn" 
                                            style="background: linear-gradient(135deg, #10b981, #059669);" 
                                            title="XÃ¡c nháº­n Ä‘Ã£ hoÃ n tiá»n"
                                            onclick="return confirm('XÃ¡c nháº­n Ä‘Ã£ hoÃ n tiá»n cho Ä‘Æ¡n hÃ ng nÃ y?');">
                                        ğŸ’¸
                                    </button>
                                </form>
                            }
                            <a asp-action="Delete" asp-route-id="@o.Id" class="action-btn delete" title="XÃ³a"
                               onclick="return confirm('Báº¡n cÃ³ cháº¯c muá»‘n xÃ³a Ä‘Æ¡n hÃ ng nÃ y?')">
                                ğŸ—‘ï¸
                            </a>
                        </div>
                    </td>
                </tr>
            }
        </tbody>
    </table>
</div>

@section Scripts {
<script src="~/admin/js/admin-table.js"></script>
<script>
function filterTable() { 
    window.filterTable('searchOrder', 'orderTable'); 
}
function filterByStatus() {
    window.filterByStatus('filterStatus', 'orderTable');
}
function submitBulkDelete() {
    window.submitBulkDelete('Ä‘Æ¡n hÃ ng');
}
</script>
}