@using ASM1_NET.Models
@model IEnumerable<Order>
@{
    ViewData["Title"] = "ƒê∆°n c·ªßa t√¥i";
    var deliveringCount = ViewBag.DeliveringCount ?? 0;
    var completedCount = ViewBag.CompletedCount ?? 0;
    var totalEarnings = ViewBag.TotalEarnings ?? 0m;
}

<h1 class="shipper-title">üöö ƒê∆°n h√†ng c·ªßa t√¥i</h1>

<!-- ALERTS -->
@if (TempData["Error"] != null)
{
    <div class="admin-alert danger" style="margin-bottom: 20px;">
        ‚ö†Ô∏è @TempData["Error"]
    </div>
}

@if (TempData["Success"] != null)
{
    <div class="admin-alert success" style="margin-bottom: 20px;">
        ‚úÖ @TempData["Success"]
    </div>
}

<!-- STATS -->
<div class="shipper-stats">
    <div class="shipper-stat-card">
        <div class="shipper-stat-icon warning">üö¥</div>
        <div class="shipper-stat-info">
            <h3>@deliveringCount</h3>
            <p>ƒêang giao</p>
        </div>
    </div>
    <div class="shipper-stat-card">
        <div class="shipper-stat-icon success">‚úÖ</div>
        <div class="shipper-stat-info">
            <h3>@completedCount</h3>
            <p>Ho√†n th√†nh</p>
        </div>
    </div>
    <div class="shipper-stat-card">
        <div class="shipper-stat-icon info">üí∞</div>
        <div class="shipper-stat-info">
            <h3>@(((decimal)totalEarnings).ToString("N0")) ‚Ç´</h3>
            <p>T·ªïng doanh thu</p>
        </div>
    </div>
</div>

@if (!Model.Any())
{
    <div class="empty-state">
        <div class="icon">üì≠</div>
        <h3>Ch∆∞a c√≥ ƒë∆°n h√†ng n√†o</h3>
        <p>H√£y nh·∫≠n ƒë∆°n t·ª´ danh s√°ch ƒë∆°n ch·ªù giao!</p>
        <a href="/Shipper/Dashboard" class="order-btn accept" style="display: inline-block; margin-top: 15px; padding: 12px 30px;">
            üìã Xem ƒë∆°n ch·ªù giao
        </a>
    </div>
}
else
{
    <div class="order-grid">
        @foreach (var order in Model)
        {
            var statusClass = order.Status == "Delivering" ? "delivering" : "completed";
            var statusText = order.Status == "Delivering" ? "ƒêang giao" : "Ho√†n th√†nh";
            var customerName = order.Customer?.FullName ?? "Kh√°ch h√†ng";
            var customerInitial = customerName.Substring(0, 1).ToUpper();
            
            <div class="order-card">
                <div class="order-card-header">
                    <span class="order-id">#@order.OrderCode</span>
                    <span class="order-status @statusClass">@statusText</span>
                </div>
                
                <div class="order-card-body">
                    <div class="order-customer">
                        <div class="customer-avatar">@customerInitial</div>
                        <div>
                            <div class="customer-name">@customerName</div>
                            <div class="customer-phone">üìû @order.Phone</div>
                        </div>
                    </div>
                    
                    <div class="order-address">
                        <span class="icon">üìç</span>
                        @order.Address
                    </div>
                    
                    <div class="order-total">
                        <span class="total-label">T·ªïng ti·ªÅn:</span>
                        <span class="total-value">@order.TotalAmount.ToString("N0") ‚Ç´</span>
                    </div>
                    
                    @if (order.Status == "Delivering" && order.EstimatedMinutes.HasValue && order.ConfirmedAt.HasValue)
                    {
                        var elapsed = (DateTime.Now - order.ConfirmedAt.Value).TotalMinutes;
                        var remaining = order.EstimatedMinutes.Value - elapsed;
                        var progressPercent = Math.Min(100, (elapsed / order.EstimatedMinutes.Value) * 100);
                        
                        <div class="order-estimated-time" style="background: linear-gradient(135deg, rgba(59, 130, 246, 0.1), rgba(147, 51, 234, 0.1)); padding: 10px 12px; border-radius: 10px; margin-top: 10px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                                <span style="font-size: 12px; color: #64748b;">‚è±Ô∏è Th·ªùi gian giao d·ª± ki·∫øn</span>
                                <span style="font-weight: 600; color: @(remaining > 0 ? "#3b82f6" : "#22c55e");">
                                    @if (remaining > 0)
                                    {
                                        <text>C√≤n ~@((int)Math.Ceiling(remaining)) ph√∫t</text>
                                    }
                                    else
                                    {
                                        <text>‚úì ƒê√£ ƒë·ªß th·ªùi gian</text>
                                    }
                                </span>
                            </div>
                            <div style="background: #e2e8f0; border-radius: 4px; height: 6px; overflow: hidden;">
                                <div style="width: @progressPercent%; height: 100%; background: linear-gradient(90deg, #3b82f6, #22c55e); transition: width 0.3s;"></div>
                            </div>
                            <div style="font-size: 10px; color: #94a3b8; margin-top: 5px; text-align: right;">
                                Nh·∫≠n l√∫c: @order.ConfirmedAt.Value.ToString("HH:mm") ‚Ä¢ D·ª± ki·∫øn: @order.EstimatedMinutes ph√∫t
                            </div>
                        </div>
                    }
                    
                    <div class="order-payment">
                        @if (order.PaymentMethod == "QR")
                        {
                            <span class="order-payment-icon">üì±</span>
                            <span class="order-payment-text qr">Chuy·ªÉn kho·∫£n QR</span>
                            <span class="order-payment-badge paid">ƒê√£ thanh to√°n</span>
                        }
                        else
                        {
                            <span class="order-payment-icon">üíµ</span>
                            <span class="order-payment-text cod">Thu ti·ªÅn m·∫∑t</span>
                            <span class="order-payment-badge collect">Thu khi giao</span>
                        }
                    </div>
                </div>
                
                <div class="order-card-footer" style="flex-direction: column; gap: 0;">
                    @if (order.Status == "Delivering")
                    {
                        <!-- Preview ·∫£nh (t√°ch ri√™ng) -->
                        <div id="proofPreview_@order.Id" style="display: none; margin-bottom: 15px; text-align: center; padding: 10px; background: rgba(59, 130, 246, 0.1); border-radius: 10px;">
                            <img id="proofImg_@order.Id" style="max-width: 100%; max-height: 120px; border-radius: 8px; border: 2px solid var(--shipper-primary);" />
                            <div style="font-size: 11px; color: var(--shipper-primary); margin-top: 5px;">ÔøΩ ·∫¢nh x√°c nh·∫≠n</div>
                        </div>
                        
                        <!-- Row buttons -->
                        <div style="display: flex; gap: 8px; align-items: stretch;">
                            <!-- Xem chi ti·∫øt -->
                            <a href="/Shipper/Orders/Detail/@order.Id" class="order-btn view" style="flex: 0 0 50px; display: flex; align-items: center; justify-content: center;">
                                üëÅÔ∏è
                            </a>
                            
                            <!-- Form upload ·∫£nh -->
                            <form action="/Shipper/Orders/Complete" method="post" enctype="multipart/form-data" style="flex: 1; display: flex; flex-direction: column; gap: 5px;" id="completeForm_@order.Id">
                                <input type="hidden" name="id" value="@order.Id" />
                                <input type="file" name="proofImage" id="proofImage_@order.Id" accept="image/*" capture="environment" 
                                       style="display: none;" onchange="showProofPreview(@order.Id)" />
                                
                                <!-- N√∫t ch·ªçn/ch·ª•p ·∫£nh -->
                                <button type="button" class="order-btn" id="selectPhotoBtn_@order.Id"
                                        style="width: 100%; background: #3b82f6; color: white;"
                                        onclick="document.getElementById('proofImage_@order.Id').click();">
                                    üì∑ Ch·ª•p ·∫£nh
                                </button>
                                
                                <!-- N√∫t ho√†n th√†nh -->
                                <button type="submit" class="order-btn complete" id="submitBtn_@order.Id" 
                                        style="width: 100%; display: none;"
                                        onclick="return validateProofImage(@order.Id);">
                                    ‚úÖ Ho√†n th√†nh
                                </button>
                            </form>
                            
                            <!-- H·ªßy nh·∫≠n ƒë∆°n -->
                            <form action="/Shipper/Dashboard/CancelAccept" method="post" style="flex: 0 0 50px;">
                                <input type="hidden" name="id" value="@order.Id" />
                                <button type="submit" class="order-btn" style="width: 100%; height: 100%; background: #ef4444; color: white;"
                                        onclick="return confirm('B·∫°n c√≥ ch·∫Øc mu·ªën h·ªßy nh·∫≠n ƒë∆°n n√†y?');">
                                    ‚ùå
                                </button>
                            </form>
                        </div>
                    }
                    else
                    {
                        <!-- Xem chi ti·∫øt -->
                        <a href="/Shipper/Orders/Detail/@order.Id" class="order-btn view" style="flex: 0.5;">
                            üëÅÔ∏è Chi ti·∫øt
                        </a>
                        
                        <div class="order-btn" style="flex: 1; text-align: center; cursor: default; background: #d4edda; color: #155724;">
                            ‚úÖ ƒê√£ giao th√†nh c√¥ng
                        </div>
                    }
                </div>
            </div>
        }
    </div>
    
    <!-- Link to History -->
    <div style="text-align: center; margin-top: 30px;">
        <a href="/Shipper/Orders/History" style="color: var(--shipper-primary); font-weight: 600;">
            üìä Xem l·ªãch s·ª≠ giao h√†ng ƒë·∫ßy ƒë·ªß ‚Üí
        </a>
    </div>
}
