@using ASM1_NET.Models
@model IEnumerable<Order>
@{
    ViewData["Title"] = "ƒê∆°n ch·ªù giao";
    var hasDeliveringOrder = ViewBag.HasDeliveringOrder ?? false;
}

<h1 class="shipper-title">üì¶ ƒê∆°n h√†ng ch·ªù nh·∫≠n</h1>

<!-- ALERTS -->
@if (TempData["Error"] != null)
{
    <div class="admin-alert danger" style="margin-bottom: 20px;">
        ‚ö†Ô∏è @TempData["Error"]
    </div>
}

@if (TempData["Success"] != null)
{
    <div class="admin-alert success" style="margin-bottom: 20px;">
        ‚úÖ @TempData["Success"]
    </div>
}

<!-- WARNING: Must complete current order -->
@if (hasDeliveringOrder)
{
    <div class="admin-alert warning" style="margin-bottom: 20px; background: #fff3cd; color: #856404; padding: 15px 20px; border-radius: 12px;">
        ‚ö†Ô∏è <strong>B·∫°n ƒëang giao 1 ƒë∆°n h√†ng!</strong> H√£y ho√†n th√†nh ƒë∆°n h√†ng hi·ªán t·∫°i tr∆∞·ªõc khi nh·∫≠n ƒë∆°n m·ªõi.
        <a href="/Shipper/Orders/MyOrders" style="color: #856404; font-weight: 600; margin-left: 10px;">Xem ƒë∆°n c·ªßa t√¥i ‚Üí</a>
    </div>
}

<!-- STATS -->
<div class="shipper-stats">
    <div class="shipper-stat-card">
        <div class="shipper-stat-icon success">üìã</div>
        <div class="shipper-stat-info">
            <h3>@Model.Count()</h3>
            <p>ƒê∆°n ch·ªù giao</p>
        </div>
    </div>
</div>

@if (!Model.Any())
{
    <div class="empty-state">
        <div class="icon">‚úÖ</div>
        <h3>Kh√¥ng c√≥ ƒë∆°n h√†ng n√†o ƒëang ch·ªù</h3>
        <p>T·∫•t c·∫£ ƒë∆°n h√†ng ƒë√£ ƒë∆∞·ª£c nh·∫≠n. H√£y quay l·∫°i sau!</p>
    </div>
}
else
{
    <div class="order-grid">
        @foreach (var order in Model)
        {
            var customerName = order.Customer?.FullName ?? "Kh√°ch h√†ng";
            var customerInitial = customerName.Substring(0, 1).ToUpper();
            
            <div class="order-card">
                <div class="order-card-header">
                    <span class="order-id">#@order.OrderCode</span>
                    <span class="order-status pending">Ch·ªù nh·∫≠n</span>
                </div>
                
                <div class="order-card-body">
                    <div class="order-customer">
                        <div class="customer-avatar">@customerInitial</div>
                        <div>
                            <div class="customer-name">@customerName</div>
                            <div class="customer-phone">üìû @order.Phone</div>
                        </div>
                    </div>
                    
                    <div class="order-address">
                        <span class="icon">üìç</span>
                        @order.Address
                    </div>
                    
                    @if (order.DeliveryLatitude.HasValue && order.DeliveryLongitude.HasValue)
                    {
                        // Calculate distance from shop (HCM center)
                        double shopLat = 10.8231;
                        double shopLng = 106.6297;
                        double dLat = (order.DeliveryLatitude.Value - shopLat) * Math.PI / 180;
                        double dLng = (order.DeliveryLongitude.Value - shopLng) * Math.PI / 180;
                        double a = Math.Sin(dLat/2) * Math.Sin(dLat/2) +
                                   Math.Cos(shopLat * Math.PI / 180) * Math.Cos(order.DeliveryLatitude.Value * Math.PI / 180) *
                                   Math.Sin(dLng/2) * Math.Sin(dLng/2);
                        double c = 2 * Math.Atan2(Math.Sqrt(a), Math.Sqrt(1-a));
                        double distance = 6371 * c;
                        int estimatedMinutes = Math.Max(5, (int)(distance * 3));
                        
                        <div class="order-info-row" style="display: flex; gap: 20px; margin: 10px 0; font-size: 0.9rem;">
                            <span style="color: #3b82f6;">
                                üöó <strong>@distance.ToString("F1") km</strong>
                            </span>
                            <span style="color: #f59e0b;">
                                ‚è±Ô∏è ~@estimatedMinutes ph√∫t
                            </span>
                        </div>
                    }
                    
                    <div class="order-total">
                        <span class="total-label">T·ªïng ti·ªÅn:</span>
                        <span class="total-value">@order.TotalAmount.ToString("N0") ‚Ç´</span>
                    </div>
                </div>
                
                <div class="order-card-footer">
                    @if (hasDeliveringOrder)
                    {
                        <button class="order-btn view" style="flex: 1; cursor: not-allowed; opacity: 0.5;" disabled>
                            üö´ Ho√†n th√†nh ƒë∆°n tr∆∞·ªõc
                        </button>
                    }
                    else
                    {
                        <form action="/Shipper/Dashboard/Accept" method="post" style="flex: 1;" onsubmit="return getShipperGPS(this)">
                            <input type="hidden" name="id" value="@order.Id" />
                            <input type="hidden" name="shipperLat" class="shipper-lat" />
                            <input type="hidden" name="shipperLng" class="shipper-lng" />
                            <button type="submit" class="order-btn accept" style="width: 100%;">
                                ‚úÖ Nh·∫≠n ƒë∆°n
                            </button>
                        </form>
                    }
                </div>
            </div>
        }
    </div>
}

<script>
    // Get shipper GPS when accepting order
    function getShipperGPS(form) {
        var latInput = form.querySelector('.shipper-lat');
        var lngInput = form.querySelector('.shipper-lng');
        
        if (navigator.geolocation) {
            // Try to get cached position first (faster)
            navigator.geolocation.getCurrentPosition(
                function(position) {
                    latInput.value = position.coords.latitude;
                    lngInput.value = position.coords.longitude;
                    form.submit();
                },
                function(error) {
                    // Submit anyway without GPS (will use default 15 min)
                    console.log('GPS error:', error.message);
                    form.submit();
                },
                { enableHighAccuracy: false, timeout: 3000, maximumAge: 60000 }
            );
            return false; // Prevent immediate submit, wait for GPS
        }
        
        return true; // No geolocation, submit normally
    }
</script>